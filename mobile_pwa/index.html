<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Transpontual – Checklist Veicular</title>

  <!-- Estilos básicos, toque-first -->
  <style>
    :root{
      --primary:#0d6efd; --bg:#f7f7f7; --text:#111; --muted:#6b7280;
      --card:#fff; --border:#e5e7eb; --danger:#ffd9d9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--text);background:var(--bg)}
    header{position:sticky;top:0;z-index:5;background:var(--primary);color:#fff;padding:12px 16px;font-weight:600}
    .container{padding:12px 12px 100px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .field{flex:1;min-width:160px}
    label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);font-size:16px;background:#fff}
    button.primary{background:var(--primary);border:none;color:#fff;font-weight:600}
    button:disabled{opacity:.6}
    .item{padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;margin-bottom:10px}
    .item header{display:flex;justify-content:space-between;align-items:center;background:transparent;padding:0;margin:0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eee}
    .danger{background:var(--danger)}
    .muted{color:var(--muted)}
    .ok-toggle{display:flex;gap:12px;margin-top:8px;align-items:center}
    .ok-toggle input{width:auto}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fafafa;font-size:14px;cursor:pointer;user-select:none}
    .chip.active{background:#ffe3e3;border-color:#ff9a9a}
    .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:10px 0}
    .progress>div{height:100%;background:var(--primary);width:0%}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:10px 12px;box-shadow:0 -2px 6px rgba(0,0,0,.06)}
    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.96;display:none}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <header>Transpontual • Checklist Veicular</header>

  <div class="container">

    <!-- Card de conexão/API -->
    <div class="card">
      <div class="row">
        <div class="field">
          <label>API Base</label>
          <input id="api_base_input" placeholder="http://127.0.0.1:8005">
          <div class="help">
            Dica: você pode passar <code>?api=http://IP:8005</code> na URL ou salvar aqui.
          </div>
        </div>
        <div class="field" style="max-width:180px">
          <label>&nbsp;</label>
          <button class="primary" id="btnSaveApi">Salvar API</button>
        </div>
      </div>
      <div class="help" id="apiStatus">API: verificando…</div>
    </div>

    <!-- Card inicial -->
    <div class="card" id="starter">
      <div class="row">
        <div class="field"><label>Veículo ID</label><input id="veiculo_id" type="number" value="1"></div>
        <div class="field"><label>Motorista ID</label><input id="motorista_id" type="number" value="1"></div>
        <div class="field">
          <label>Modelo de Checklist</label>
          <select id="modelo_id"></select>
        </div>
      </div>
      <div class="row">
        <div class="field"><label>Odômetro inicial</label><input id="odo_ini" type="number" value="0"></div>
        <div class="field"><label>Geo início (auto)</label><input id="geo_inicio" placeholder="localizando…" readonly></div>
      </div>
      <button class="primary" id="btnStart">Iniciar checklist</button>
    </div>

    <!-- Trabalho -->
    <div class="card" id="workArea" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Checklist #<span id="cid"></span></strong></div>
        <span class="badge" id="cstatus">pendente</span>
      </div>
      <div class="progress"><div id="pbar"></div></div>
      <div id="items"></div>
    </div>
  </div>

  <!-- Rodapé -->
  <div class="footer" id="footer" style="display:none">
    <div class="row">
      <div class="field"><input id="odo_fim" type="number" placeholder="Odômetro final (opcional)"></div>
      <div class="field" style="max-width:200px"><button class="primary" id="btnFinish">Finalizar</button></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ------------------------- Config da API ------------------------- */
function getAPIBase() {
  const qs = new URLSearchParams(location.search).get('api');
  if (qs) return qs;
  const stored = localStorage.getItem('API_BASE');
  if (stored) return stored;
  if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.origin.startsWith('file:')) {
    return 'http://127.0.0.1:8005';
  }
  // produção: mesmo host (ajuste porta se necessário)
  return `${location.protocol}//${location.hostname}:8005`;
}
let API = getAPIBase().replace(/\/+$/, '');
document.getElementById('api_base_input').value = API;

document.getElementById('btnSaveApi').onclick = () => {
  const v = document.getElementById('api_base_input').value.trim().replace(/\/+$/, '');
  if (!v) return;
  localStorage.setItem('API_BASE', v);
  API = v;
  pingAPI().then();
  toast('API salva: ' + v);
};

/* --------------------------- Utilidades ------------------------- */
function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', 2200);
}
async function fetchJSON(url, opts={}){
  const r = await fetch(url, opts);
  if(!r.ok){
    const t = await r.text();
    throw new Error(t || (r.status + ' ' + r.statusText));
  }
  try { return await r.json(); } catch { return {}; }
}
async function postJSON(path, body){
  return await fetchJSON(API + path, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
}

/* ------------------------- API helpers -------------------------- */
async function pingAPI(){
  try{
    const h = await fetchJSON(API + '/health');
    document.getElementById('apiStatus').textContent = 'API: ' + (h.status || 'ok');
  }catch(e){
    document.getElementById('apiStatus').textContent = 'API: indisponível (' + e.message + ')';
  }
}
async function getModels(){ return await fetchJSON(API + '/checklist/modelos'); }
async function getChecklist(id){ return await fetchJSON(API + '/checklist/' + id); }

/* --------------------------- UI lógica -------------------------- */
function progress(done,total){
  const pct = total? Math.round((done/total)*100) : 0;
  document.getElementById('pbar').style.width = pct + '%';
}
function renderItems(data){
  const wrap = document.getElementById('items');
  wrap.innerHTML = '';
  const respostas = {};
  (data.respostas || []).forEach(r => respostas[r.item_id] = r);
  let responded = Object.keys(respostas).length;

  (data.itens || []).forEach(it=>{
    const el = document.createElement('div');
    el.className = 'item';
    const isNOK = respostas[it.id]?.valor === 'nao_ok';
    el.innerHTML = `
      <header>
        <div>#${it.ordem} • ${it.descricao}</div>
        <span class="badge ${it.bloqueia_viagem?'danger':''}">
          ${it.severidade}${it.bloqueia_viagem?' • bloqueia':''}
        </span>
      </header>

      <div class="ok-toggle">
        <label><input type="radio" name="ok_${it.id}" value="ok" ${!isNOK && respostas[it.id] ? 'checked':''}> Sem avaria</label>
        <label><input type="radio" name="ok_${it.id}" value="nao_ok" ${isNOK ? 'checked':''}> Com avaria</label>
        <label><input type="radio" name="ok_${it.id}" value="na" ${(!respostas[it.id]) ? 'checked':''}> N.A.</label>
      </div>

      <div class="chips" id="chips_${it.id}" style="display:${isNOK?'flex':'none'}">
        ${(it.opcoes||[]).map(op=>`<div class="chip ${respostas[it.id]?.observacao===op?'active':''}" data-op="${op}">${op}</div>`).join('')}
      </div>
    `;

    // Troca OK/NOK/NA
    el.querySelectorAll(`input[name="ok_${it.id}"]`).forEach(r=>{
      r.addEventListener('change', async (e)=>{
        const val = e.target.value;
        const chips = el.querySelector(`#chips_${it.id}`);
        chips.style.display = (val==='nao_ok') ? 'flex' : 'none';
        try{
          await postJSON('/checklist/answer', { checklist_id: data.id, respostas: [{ item_id: it.id, valor: val, observacao: null }] });
          if(!respostas[it.id]){ responded++; progress(responded, data.itens.length); }
        }catch(err){ toast('Erro: ' + err.message); }
      });
    });

    // Seleção de avaria (chip)
    el.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', async ()=>{
        const opcao = ch.dataset.op;
        el.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        try{
          await postJSON('/checklist/answer', { checklist_id: data.id, respostas: [{ item_id: it.id, valor: 'nao_ok', observacao: opcao }] });
          toast('Anotado: ' + opcao);
        }catch(err){ toast('Erro: ' + err.message); }
      });
    });

    wrap.appendChild(el);
  });

  progress(responded, data.itens?.length || 0);
}

/* --------------------------- Boot ------------------------------- */
async function geoInit(){
  try{
    const p = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:6000}));
    const s = `${p.coords.latitude.toFixed(6)},${p.coords.longitude.toFixed(6)}`;
    document.getElementById('geo_inicio').value = s;
    return s;
  }catch{ document.getElementById('geo_inicio').placeholder='geo indisponível'; return null; }
}

async function boot(){
  // Ping da API e modelos
  pingAPI().then();
  const sel = document.getElementById('modelo_id');
  try{
    const modelos = await getModels();
    if(!Array.isArray(modelos) || modelos.length===0){
      sel.innerHTML = '<option value="">(sem modelos)</option>';
    }else{
      modelos.forEach(m=>{
        const o = document.createElement('option');
        o.value = m.id; o.textContent = `#${m.id} - ${m.nome} (${m.tipo})`;
        sel.appendChild(o);
      });
    }
  }catch(e){
    sel.innerHTML = '<option value="">(erro ao carregar)</option>';
    toast('Falha ao carregar modelos: ' + e.message);
  }

  // Geo início
  geoInit();

  // Start
  document.getElementById('btnStart').onclick = async ()=>{
    const veiculo_id = +document.getElementById('veiculo_id').value;
    const motorista_id = +document.getElementById('motorista_id').value;
    const modelo_id = +document.getElementById('modelo_id').value || null;
    const odometro_ini = +document.getElementById('odo_ini').value || 0;
    const geo_inicio = document.getElementById('geo_inicio').value || null;
    if(!veiculo_id || !motorista_id || !modelo_id){ toast('Preencha veículo, motorista e modelo.'); return; }

    try{
      const c = await postJSON('/checklist/start', { veiculo_id, motorista_id, modelo_id, tipo:'pre', odometro_ini, geo_inicio });
      document.getElementById('starter').style.display='none';
      document.getElementById('workArea').style.display='block';
      document.getElementById('footer').style.display='block';
      document.getElementById('cid').textContent = c.id;
      const data = await getChecklist(c.id);
      document.getElementById('cstatus').textContent = (data.status || 'pendente').toUpperCase();
      renderItems(data);

      // Finish
      document.getElementById('btnFinish').onclick = async ()=>{
        try{
          const odometro_fim = +document.getElementById('odo_fim').value || null;
          await postJSON('/checklist/finish', { checklist_id: data.id, odometro_fim });
          const novo = await getChecklist(data.id);
          document.getElementById('cstatus').textContent = (novo.status || '').toUpperCase();
          toast('Checklist finalizado: ' + (novo.status || '').toUpperCase());
        }catch(err){ toast('Erro ao finalizar: ' + err.message); }
      };

    }catch(err){
      toast('Erro ao iniciar: ' + err.message);
    }
  };
}
boot();
</script>
</body>
</html>
