{% extends "base.html" %}

{% block title %}Veículos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Gestão de Veículos</h1>
        <div>
            <a href="{{ url_for('vehicle_new') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Novo Veículo
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row">
                <div class="col-md-3">
                    <label for="placa" class="form-label">Placa</label>
                    <input type="text" class="form-control" id="placa" name="placa"
                           value="{{ request.args.get('placa', '') }}" placeholder="ABC-1234">
                </div>
                <div class="col-md-3">
                    <label for="marca" class="form-label">Marca</label>
                    <input type="text" class="form-control" id="marca" name="marca"
                           value="{{ request.args.get('marca', '') }}" placeholder="Volkswagen, Ford...">
                </div>
                <div class="col-md-3">
                    <label for="tipo" class="form-label">Tipo</label>
                    <select class="form-select" id="tipo" name="tipo">
                        <option value="">Todos os tipos</option>
                        <option value="caminhao" {{ 'selected' if request.args.get('tipo') == 'caminhao' }}>Caminhão</option>
                        <option value="van" {{ 'selected' if request.args.get('tipo') == 'van' }}>Van</option>
                        <option value="carro" {{ 'selected' if request.args.get('tipo') == 'carro' }}>Carro</option>
                        <option value="moto" {{ 'selected' if request.args.get('tipo') == 'moto' }}>Moto</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="ativo" class="form-label">Status</label>
                    <select class="form-select" id="ativo" name="ativo">
                        <option value="">Todos</option>
                        <option value="true" {{ 'selected' if request.args.get('ativo') == 'true' }}>Ativo</option>
                        <option value="false" {{ 'selected' if request.args.get('ativo') == 'false' }}>Inativo</option>
                    </select>
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('vehicles_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Veículos -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                Veículos
                {% if veiculos %}
                    <span class="badge bg-secondary">{{ veiculos|length }}</span>
                {% endif %}
            </h6>
        </div>
        <div class="card-body">
            {% if veiculos %}
                <!-- Busca rápida -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text"
                                   class="form-control"
                                   id="quickSearch"
                                   placeholder="Busca rápida na tabela...">
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">Total: {{ veiculos|length }} veículos</small>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="vehiclesTable">
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th>Marca/Modelo</th>
                                <th>Tipo</th>
                                <th>Ano</th>
                                <th>KM Atual</th>
                                <th>Status</th>
                                <th>Manutenção</th>
                                <th>Última Atualização</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for veiculo in veiculos %}
                            <tr>
                                <td>
                                    <strong>{{ veiculo.placa or 'N/A' }}</strong>
                                    {% if veiculo.renavam %}
                                        <br><small class="text-muted">RENAVAM: {{ veiculo.renavam }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if veiculo.marca or veiculo.modelo %}
                                        {{ veiculo.marca or '' }} {{ veiculo.modelo or '' }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if veiculo.tipo %}
                                        <span class="badge bg-info">{{ veiculo.tipo|title }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ veiculo.ano or '-' }}</td>
                                <td>
                                    {% if veiculo.km_atual %}
                                        {{ "{:,}".format(veiculo.km_atual).replace(',', '.') }} km
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if veiculo.ativo %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inativo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if veiculo.em_manutencao %}
                                        <span class="badge bg-warning text-dark"
                                              title="{{ veiculo.observacoes_manutencao or 'Em manutenção' }}">
                                            <i class="fas fa-tools"></i> Em Manutenção
                                        </span>
                                        {% if veiculo.observacoes_manutencao %}
                                            <br><small class="text-muted">{{ veiculo.observacoes_manutencao[:50] }}{% if veiculo.observacoes_manutencao|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-light text-dark">Operacional</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if veiculo.criado_em %}
                                        {{ veiculo.criado_em|date }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('vehicle_edit', vehicle_id=veiculo.id) }}"
                                           class="btn btn-sm btn-outline-info"
                                           title="Ver detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('vehicle_edit', vehicle_id=veiculo.id) }}"
                                           class="btn btn-sm btn-outline-primary"
                                           title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger"
                                                title="Excluir"
                                                onclick="confirmDelete({{ veiculo.id }}, '{{ veiculo.placa }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum veículo encontrado</h5>
                    <p class="text-muted">
                        {% if request.args %}
                            Tente ajustar os filtros ou
                            <a href="{{ url_for('vehicles_list') }}">limpar a busca</a>.
                        {% else %}
                            Comece cadastrando o primeiro veículo da frota.
                        {% endif %}
                    </p>
                    <a href="{{ url_for('vehicle_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Cadastrar Primeiro Veículo
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Estatísticas Rápidas -->
    {% if veiculos %}
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total de Veículos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ veiculos|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Ativos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ veiculos|selectattr('ativo')|list|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tipos Diferentes</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ veiculos|map(attribute='tipo')|reject('none')|unique|list|length or 0 }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">KM Total</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% set total_km = veiculos|map(attribute='km_atual')|select('number')|sum %}
                                {% if total_km > 0 %}
                                    {{ "{:,}".format(total_km).replace(',', '.') }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o veículo <strong id="vehiclePlate"></strong>?</p>
                <p class="text-muted"><small>Esta ação não pode ser desfeita.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Aguardar carregamento completo sem jQuery para evitar conflitos
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de veículos carregada com {{ veiculos|length }} veículos');

    // Adicionar funcionalidade de busca simples na tabela
    const searchInput = document.getElementById('quickSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterTable(this.value);
        });
    }
});

// Função de busca simples na tabela
function filterTable(searchTerm) {
    const table = document.getElementById('vehiclesTable');
    if (!table) return;

    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    const term = searchTerm.toLowerCase();

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent || row.innerText;

        if (text.toLowerCase().includes(term)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// Variável global para exclusão
let vehicleToDelete = null;

// Função para confirmar exclusão
function confirmDelete(vehicleId, vehiclePlate) {
    vehicleToDelete = vehicleId;
    const plateElement = document.getElementById('vehiclePlate');
    if (plateElement) {
        plateElement.textContent = vehiclePlate;
    }

    const modalElement = document.getElementById('deleteModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
}

// Event listener para confirmação de exclusão
document.addEventListener('DOMContentLoaded', function() {
    const confirmButton = document.getElementById('confirmDelete');
    if (confirmButton) {
        confirmButton.addEventListener('click', function() {
            if (vehicleToDelete) {
                // Mostrar indicador de carregamento
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
                this.disabled = true;

                // Chamada AJAX para excluir o veículo via API local
                fetch(`/api/vehicles/${vehicleToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                })
                .then(data => {
                    if (data.message) {
                        // Sucesso - mostrar mensagem e recarregar
                        alert('Veículo excluído com sucesso!');
                        location.reload();
                    } else {
                        // Erro - mostrar mensagem
                        alert(data.error || 'Erro ao excluir veículo. Tente novamente.');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir veículo. Verifique se não há dependências (checklists) vinculadas.');
                });
            }

            const modalElement = document.getElementById('deleteModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
        });
    }
});
</script>
{% endblock %}