{% extends "base.html" %}

{% block title %}Detalhes do Abastecimento{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 mb-0 text-gray-800">Detalhes do Abastecimento #{{ abastecimento.id }}</h1>
        <div>
            <a href="{{ url_for('abastecimento_edit', abastecimento_id=abastecimento.id) }}" class="btn btn-warning" title="API em desenvolvimento">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{{ url_for('abastecimentos_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar à Lista
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Informações Principais -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Informações do Abastecimento</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold" width="40%">Data/Hora:</td>
                                    <td>{{ abastecimento.data_abastecimento|datetime if abastecimento.data_abastecimento else '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Veículo:</td>
                                    <td>
                                        {% if abastecimento.veiculo %}
                                            <span class="fw-bold">{{ abastecimento.veiculo.placa }}</span><br>
                                            <small class="text-muted">{{ abastecimento.veiculo.marca }} {{ abastecimento.veiculo.modelo }}</small>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Motorista:</td>
                                    <td>{{ abastecimento.motorista.nome if abastecimento.motorista else '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Posto:</td>
                                    <td>{{ abastecimento.posto or '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Tipo Combustível:</td>
                                    <td>
                                        <span class="badge bg-info">{{ abastecimento.tipo_combustivel or 'Diesel' }}</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold" width="40%">Odômetro:</td>
                                    <td>{{ "{:,}".format(abastecimento.odometro).replace(',', '.') if abastecimento.odometro else '-' }} km</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Litros:</td>
                                    <td class="fs-5 text-primary fw-bold">{{ abastecimento.litros }}L</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Valor por Litro:</td>
                                    <td>R$ {{ abastecimento.valor_litro }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Valor Total:</td>
                                    <td class="fs-4 text-success fw-bold">R$ {{ abastecimento.valor_total }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Cupom Fiscal:</td>
                                    <td>{{ abastecimento.numero_cupom or '-' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    {% if abastecimento.observacoes %}
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="fw-bold">Observações:</h6>
                            <div class="bg-light p-3 rounded">
                                {{ abastecimento.observacoes }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Informações de Auditoria -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-secondary">Informações de Registro</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Registrado em:</strong> {{ abastecimento.criado_em|datetime if abastecimento.criado_em else '-' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>ID do Registro:</strong> #{{ abastecimento.id }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Resumo Financeiro -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-success">Resumo Financeiro</h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-fuel-pump display-4 text-success"></i>
                    </div>
                    <div class="mb-3">
                        <h4 class="text-success">R$ {{ abastecimento.valor_total }}</h4>
                        <p class="text-muted mb-0">Valor Total</p>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold text-primary">{{ abastecimento.litros }}L</div>
                            <small class="text-muted">Litros</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold text-info">R$ {{ abastecimento.valor_litro }}</div>
                            <small class="text-muted">Por Litro</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ações -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-dark">Ações</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('abastecimento_edit', abastecimento_id=abastecimento.id) }}"
                           class="btn btn-warning" title="API em desenvolvimento">
                            <i class="bi bi-pencil"></i> Editar Abastecimento
                        </a>
                        <button type="button" class="btn btn-outline-primary" onclick="imprimirRelatorio()">
                            <i class="bi bi-printer"></i> Imprimir Comprovante
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmarExclusao()" title="API em desenvolvimento">
                            <i class="bi bi-trash"></i> Excluir Registro
                        </button>
                    </div>
                </div>
            </div>

            <!-- Informações do Veículo -->
            {% if abastecimento.veiculo %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Informações do Veículo</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-truck display-4 text-primary"></i>
                    </div>
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="fw-bold">Placa:</td>
                            <td>{{ abastecimento.veiculo.placa }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Marca/Modelo:</td>
                            <td>{{ abastecimento.veiculo.marca }} {{ abastecimento.veiculo.modelo }}</td>
                        </tr>
                        {% if abastecimento.veiculo.ano %}
                        <tr>
                            <td class="fw-bold">Ano:</td>
                            <td>{{ abastecimento.veiculo.ano }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="fw-bold">KM Atual:</td>
                            <td>{{ "{:,}".format(abastecimento.veiculo.km_atual).replace(',', '.') if abastecimento.veiculo.km_atual else '-' }} km</td>
                        </tr>
                    </table>
                    <div class="d-grid">
                        <a href="{{ url_for('vehicle_edit', vehicle_id=abastecimento.veiculo.id) }}"
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil-square"></i> Ver/Editar Veículo
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                </div>
                <p class="text-center">Tem certeza que deseja excluir este registro de abastecimento?</p>
                <div class="alert alert-warning">
                    <strong>Atenção:</strong> Esta ação não pode ser desfeita e removerá permanentemente:
                    <ul class="mb-0 mt-2">
                        <li>Dados do abastecimento</li>
                        <li>Informações financeiras</li>
                        <li>Histórico de consumo</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('abastecimento_delete', abastecimento_id=abastecimento.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Confirmar Exclusão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmarExclusao() {
    const modal = new bootstrap.Modal(document.getElementById('modalExclusao'));
    modal.show();
}

function imprimirRelatorio() {
    // Criar uma nova janela para impressão
    const printWindow = window.open('', '_blank');

    const content = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Comprovante de Abastecimento #{{ abastecimento.id }}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                .section { margin-bottom: 15px; }
                .label { font-weight: bold; }
                .value { margin-left: 10px; }
                .total { font-size: 18px; font-weight: bold; color: #28a745; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>COMPROVANTE DE ABASTECIMENTO</h2>
                <p>Transpontual - Sistema de Gestão de Frotas</p>
            </div>

            <div class="section">
                <div><span class="label">Registro:</span><span class="value">#{{ abastecimento.id }}</span></div>
                <div><span class="label">Data/Hora:</span><span class="value">{{ abastecimento.data_abastecimento|datetime if abastecimento.data_abastecimento else '-' }}</span></div>
            </div>

            <div class="section">
                <div><span class="label">Veículo:</span><span class="value">{{ abastecimento.veiculo.placa if abastecimento.veiculo else '-' }} - {{ abastecimento.veiculo.marca if abastecimento.veiculo else '' }} {{ abastecimento.veiculo.modelo if abastecimento.veiculo else '' }}</span></div>
                <div><span class="label">Motorista:</span><span class="value">{{ abastecimento.motorista.nome if abastecimento.motorista else '-' }}</span></div>
                <div><span class="label">Odômetro:</span><span class="value">{{ "{:,}".format(abastecimento.odometro).replace(',', '.') if abastecimento.odometro else '-' }} km</span></div>
            </div>

            <div class="section">
                <div><span class="label">Posto:</span><span class="value">{{ abastecimento.posto or '-' }}</span></div>
                <div><span class="label">Combustível:</span><span class="value">{{ abastecimento.tipo_combustivel or 'Diesel' }}</span></div>
                <div><span class="label">Cupom:</span><span class="value">{{ abastecimento.numero_cupom or '-' }}</span></div>
            </div>

            <div class="section">
                <div><span class="label">Litros:</span><span class="value">{{ abastecimento.litros }}L</span></div>
                <div><span class="label">Valor por Litro:</span><span class="value">R$ {{ abastecimento.valor_litro }}</span></div>
                <div class="total"><span class="label">VALOR TOTAL:</span><span class="value">R$ {{ abastecimento.valor_total }}</span></div>
            </div>

            {% if abastecimento.observacoes %}
            <div class="section">
                <div><span class="label">Observações:</span></div>
                <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">{{ abastecimento.observacoes }}</div>
            </div>
            {% endif %}

            <div class="section" style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                <p>Documento gerado em ' + new Date().toLocaleString('pt-BR') + '</p>
            </div>
        </body>
        </html>
    `;

    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
</script>
{% endblock %}