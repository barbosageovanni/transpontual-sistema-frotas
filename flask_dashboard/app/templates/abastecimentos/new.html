{% extends "base.html" %}

{% block title %}Novo Abastecimento{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 mb-0 text-gray-800">Novo Abastecimento</h1>
        <div>
            <a href="{{ url_for('abastecimentos_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar à Lista
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Dados do Abastecimento</h6>
                </div>
                <div class="card-body">
                    <form method="POST" id="abastecimento-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="veiculo_id" class="form-label">Veículo *</label>
                                <select class="form-select" id="veiculo_id" name="veiculo_id" required>
                                    <option value="">Selecione um veículo</option>
                                    {% for veiculo in veiculos %}
                                    <option value="{{ veiculo.id }}"
                                            data-km="{{ veiculo.km_atual }}"
                                            {{ 'selected' if request.form.get('veiculo_id') == veiculo.id|string }}>
                                        {{ veiculo.placa }} - {{ veiculo.marca }} {{ veiculo.modelo }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Selecione o veículo abastecido</div>
                            </div>
                            <div class="col-md-6">
                                <label for="motorista_id" class="form-label">Motorista *</label>
                                <select class="form-select" id="motorista_id" name="motorista_id" required>
                                    <option value="">Selecione um motorista</option>
                                    {% for motorista in motoristas %}
                                    <option value="{{ motorista.id }}"
                                            {{ 'selected' if request.form.get('motorista_id') == motorista.id|string }}>
                                        {{ motorista.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Motorista responsável pelo abastecimento</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="data_abastecimento" class="form-label">Data e Hora *</label>
                                <input type="datetime-local" class="form-control" id="data_abastecimento"
                                       name="data_abastecimento" value="{{ request.form.get('data_abastecimento') or '' }}" required>
                                <div class="form-text">Data e hora do abastecimento</div>
                            </div>
                            <div class="col-md-6">
                                <label for="odometro" class="form-label">Odômetro (km) *</label>
                                <input type="number" class="form-control" id="odometro" name="odometro"
                                       value="{{ request.form.get('odometro') or '' }}" min="0" required>
                                <div class="form-text">Quilometragem atual do veículo</div>
                                <div id="km-warning" class="text-warning" style="display: none;">
                                    <small><i class="bi bi-exclamation-triangle"></i> Verifique a quilometragem informada</small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="litros" class="form-label">Litros *</label>
                                <input type="number" class="form-control" id="litros" name="litros"
                                       value="{{ request.form.get('litros') or '' }}" step="0.001" min="0" required>
                                <div class="form-text">Quantidade de combustível</div>
                            </div>
                            <div class="col-md-4">
                                <label for="valor_litro" class="form-label">Valor por Litro (R$) *</label>
                                <input type="number" class="form-control" id="valor_litro" name="valor_litro"
                                       value="{{ request.form.get('valor_litro') or '' }}" step="0.001" min="0" required>
                                <div class="form-text">Preço por litro</div>
                            </div>
                            <div class="col-md-4">
                                <label for="valor_total" class="form-label">Valor Total (R$) *</label>
                                <input type="number" class="form-control" id="valor_total" name="valor_total"
                                       value="{{ request.form.get('valor_total') or '' }}" step="0.01" min="0" required readonly>
                                <div class="form-text">Calculado automaticamente</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="fornecedor_id" class="form-label">
                                    Fornecedor/Posto
                                    <a href="{{ url_for('fornecedor_new') }}" class="btn btn-sm btn-link p-0 ms-2" title="Novo Fornecedor" target="_blank">
                                        <i class="bi bi-plus-circle"></i>
                                    </a>
                                </label>
                                <select class="form-select" id="fornecedor_id" name="fornecedor_id">
                                    <option value="">Selecione um fornecedor</option>
                                    {% for fornecedor in fornecedores %}
                                    <option value="{{ fornecedor.id }}"
                                            data-nome="{{ fornecedor.nome }}"
                                            {{ 'selected' if request.form.get('fornecedor_id') == fornecedor.id|string }}>
                                        {{ fornecedor.nome }} {% if fornecedor.cidade %}({{ fornecedor.cidade }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Selecione o posto/fornecedor cadastrado</div>
                            </div>
                            <div class="col-md-6">
                                <label for="posto" class="form-label">Nome do Posto (Manual)</label>
                                <input type="text" class="form-control" id="posto" name="posto"
                                       value="{{ request.form.get('posto') or '' }}" placeholder="Ou digite o nome do posto">
                                <div class="form-text">Campo preenchido automaticamente ao selecionar fornecedor</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="tipo_combustivel" class="form-label">Tipo de Combustível</label>
                                <select class="form-select" id="tipo_combustivel" name="tipo_combustivel">
                                    <option value="Diesel" {{ 'selected' if request.form.get('tipo_combustivel', 'Diesel') == 'Diesel' }}>Diesel</option>
                                    <option value="Gasolina" {{ 'selected' if request.form.get('tipo_combustivel') == 'Gasolina' }}>Gasolina</option>
                                    <option value="Etanol" {{ 'selected' if request.form.get('tipo_combustivel') == 'Etanol' }}>Etanol</option>
                                    <option value="GNV" {{ 'selected' if request.form.get('tipo_combustivel') == 'GNV' }}>GNV</option>
                                    <option value="Arla 32" {{ 'selected' if request.form.get('tipo_combustivel') == 'Arla 32' }}>Arla 32</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <!-- Espaço vazio para alinhamento -->
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="numero_cupom" class="form-label">Número do Cupom</label>
                                <input type="text" class="form-control" id="numero_cupom" name="numero_cupom"
                                       value="{{ request.form.get('numero_cupom') or '' }}" placeholder="Número do cupom fiscal">
                                <div class="form-text">Número do cupom fiscal (opcional)</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                                      placeholder="Observações adicionais sobre o abastecimento">{{ request.form.get('observacoes') or '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Registrar Abastecimento
                                </button>
                                <a href="{{ url_for('abastecimentos_list') }}" class="btn btn-secondary ms-2">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Card de Upload de Cupom -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 fw-bold">
                        <i class="bi bi-camera"></i> Extrair do Cupom Fiscal
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-receipt display-4 text-success"></i>
                    </div>
                    <p class="text-muted">Tire uma foto do cupom fiscal e os dados serão preenchidos automaticamente!</p>

                    <div class="mb-3">
                        <input type="file" class="form-control" id="cupom_file" accept="image/*,application/pdf" capture="environment">
                        <div class="form-text">Formatos: JPG, PNG, PDF</div>
                    </div>

                    <button type="button" class="btn btn-success w-100" id="btn-processar-cupom" disabled>
                        <i class="bi bi-magic"></i> Extrair Dados do Cupom
                    </button>

                    <div id="cupom-loading" class="text-center mt-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-success" role="status">
                            <span class="visually-hidden">Processando...</span>
                        </div>
                        <p class="text-muted mt-2 mb-0"><small>Processando cupom...</small></p>
                    </div>

                    <div id="cupom-result" class="alert mt-3" style="display: none;"></div>
                </div>
            </div>

            <!-- Card de Ajuda -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-info">Dicas</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-fuel-pump display-4 text-info"></i>
                    </div>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            <strong>Dados obrigatórios:</strong> Veículo, motorista, data, odômetro, litros e valores
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-calculator text-primary"></i>
                            <strong>Cálculo automático:</strong> O valor total será calculado automaticamente
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-speedometer2 text-warning"></i>
                            <strong>Odômetro:</strong> Verifique se a quilometragem está correta
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-receipt text-info"></i>
                            <strong>Cupom fiscal:</strong> Guarde o cupom para controle financeiro
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Card de Informações do Veículo -->
            <div class="card shadow mb-4" id="veiculo-info" style="display: none;">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Informações do Veículo</h6>
                </div>
                <div class="card-body">
                    <div id="veiculo-details">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Definir data/hora atual
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('data_abastecimento').value = now.toISOString().slice(0, 16);

    // ====================
    // UPLOAD DE CUPOM FISCAL
    // ====================

    // Habilitar botão quando arquivo for selecionado
    document.getElementById('cupom_file').addEventListener('change', function() {
        const btn = document.getElementById('btn-processar-cupom');
        btn.disabled = !this.files.length;
    });

    // Processar upload de cupom
    document.getElementById('btn-processar-cupom').addEventListener('click', async function() {
        const fileInput = document.getElementById('cupom_file');
        const file = fileInput.files[0];

        if (!file) {
            alert('Selecione uma imagem do cupom');
            return;
        }

        // Mostrar loading
        document.getElementById('cupom-loading').style.display = 'block';
        document.getElementById('cupom-result').style.display = 'none';
        this.disabled = true;

        try {
            // Criar FormData para enviar arquivo
            const formData = new FormData();
            formData.append('file', file);

            // Enviar para API
            const response = await fetch('{{ config.API_BASE }}/api/v1/abastecimentos/upload-cupom', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // Log detalhado para debug
            console.log('=== OCR RESPONSE ===');
            console.log('Response status:', response.status);
            console.log('Result object:', result);
            console.log('Result.success:', result.success);
            console.log('Result.data:', result.data);
            console.log('Data keys:', result.data ? Object.keys(result.data) : 'NO DATA');

            if (response.ok && result.success) {
                // Preencher formulário com dados extraídos
                const data = result.data;

                console.log('=== FILLING FORM ===');
                console.log('Posto:', data.posto);
                console.log('Litros:', data.litros);
                console.log('Valor/Litro:', data.valor_litro);
                console.log('Valor Total:', data.valor_total);
                console.log('Tipo Combustível:', data.tipo_combustivel);
                console.log('Número Cupom:', data.numero_cupom);
                console.log('Data Abastecimento:', data.data_abastecimento);
                console.log('Placa:', data.placa);
                console.log('Odômetro:', data.odometro);

                if (data.posto) {
                    document.getElementById('posto').value = data.posto;
                }

                if (data.litros) {
                    document.getElementById('litros').value = data.litros;
                }

                if (data.valor_litro) {
                    document.getElementById('valor_litro').value = data.valor_litro;
                }

                if (data.valor_total) {
                    document.getElementById('valor_total').value = data.valor_total;
                }

                // Preencher odômetro se extraído
                if (data.odometro) {
                    document.getElementById('odometro').value = data.odometro;
                    // Validar odômetro
                    validarOdometro();
                }

                // Tentar selecionar veículo pela placa
                if (data.placa) {
                    const veiculoSelect = document.getElementById('veiculo_id');
                    const options = veiculoSelect.options;

                    for (let i = 0; i < options.length; i++) {
                        const optionText = options[i].textContent.toUpperCase();
                        if (optionText.includes(data.placa.toUpperCase())) {
                            veiculoSelect.value = options[i].value;
                            // Mostrar informações do veículo
                            mostrarInfoVeiculo();
                            console.log('Veículo selecionado automaticamente pela placa:', data.placa);
                            break;
                        }
                    }
                }

                if (data.tipo_combustivel) {
                    const select = document.getElementById('tipo_combustivel');
                    const option = Array.from(select.options).find(opt =>
                        opt.value.toLowerCase() === data.tipo_combustivel.toLowerCase()
                    );
                    if (option) {
                        select.value = option.value;
                    }
                }

                if (data.numero_cupom) {
                    document.getElementById('numero_cupom').value = data.numero_cupom;
                }

                // Só preencher data se foi extraída validamente
                if (data.data_abastecimento && data.data_abastecimento !== null && data.data_abastecimento !== 'None') {
                    try {
                        const dataHora = new Date(data.data_abastecimento);
                        // Verificar se é uma data válida
                        if (!isNaN(dataHora.getTime())) {
                            dataHora.setMinutes(dataHora.getMinutes() - dataHora.getTimezoneOffset());
                            document.getElementById('data_abastecimento').value = dataHora.toISOString().slice(0, 16);
                        }
                    } catch (e) {
                        console.warn('Erro ao parsear data:', e);
                    }
                }

                // Recalcular total
                calcularTotal();

                // Mostrar mensagem de sucesso ou aviso
                const resultDiv = document.getElementById('cupom-result');
                if (result.warning) {
                    resultDiv.className = 'alert alert-warning mt-3';
                    resultDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + result.warning;
                } else {
                    resultDiv.className = 'alert alert-success mt-3';
                    resultDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + result.message + ' Verifique os campos e faça ajustes se necessário.';
                }
                resultDiv.style.display = 'block';

            } else {
                throw new Error(result.detail || 'Erro ao processar cupom');
            }

        } catch (error) {
            console.error('Erro:', error);
            const resultDiv = document.getElementById('cupom-result');
            resultDiv.className = 'alert alert-warning mt-3';
            resultDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + error.message + '. Preencha os dados manualmente.';
            resultDiv.style.display = 'block';
        } finally {
            document.getElementById('cupom-loading').style.display = 'none';
            this.disabled = false;
        }
    });

    // Calcular valor total automaticamente
    function calcularTotal() {
        const litros = parseFloat(document.getElementById('litros').value) || 0;
        const valorLitro = parseFloat(document.getElementById('valor_litro').value) || 0;
        const total = litros * valorLitro;
        document.getElementById('valor_total').value = total.toFixed(2);
    }

    // Validar odômetro com base no veículo selecionado
    function validarOdometro() {
        const veiculoSelect = document.getElementById('veiculo_id');
        const odometroInput = document.getElementById('odometro');
        const warning = document.getElementById('km-warning');

        if (veiculoSelect.value && odometroInput.value) {
            const selectedOption = veiculoSelect.options[veiculoSelect.selectedIndex];
            const kmAtual = parseInt(selectedOption.dataset.km) || 0;
            const odometroInformado = parseInt(odometroInput.value) || 0;

            if (odometroInformado < kmAtual) {
                warning.style.display = 'block';
                warning.innerHTML = `<small><i class="bi bi-exclamation-triangle"></i> Odômetro informado (${odometroInformado.toLocaleString()}km) é menor que o registrado (${kmAtual.toLocaleString()}km)</small>`;
            } else {
                warning.style.display = 'none';
            }
        }
    }

    // Mostrar informações do veículo selecionado
    function mostrarInfoVeiculo() {
        const veiculoSelect = document.getElementById('veiculo_id');
        const infoCard = document.getElementById('veiculo-info');
        const detailsDiv = document.getElementById('veiculo-details');

        if (veiculoSelect.value) {
            const selectedOption = veiculoSelect.options[veiculoSelect.selectedIndex];
            const kmAtual = parseInt(selectedOption.dataset.km) || 0;
            const texto = selectedOption.textContent;

            detailsDiv.innerHTML = `
                <div class="text-center mb-3">
                    <i class="bi bi-truck display-4 text-primary"></i>
                </div>
                <p><strong>Veículo:</strong> ${texto}</p>
                <p><strong>KM Atual:</strong> ${kmAtual.toLocaleString()} km</p>
                <div class="alert alert-info">
                    <small><i class="bi bi-info-circle"></i> Informe o odômetro atual do veículo</small>
                </div>
            `;
            infoCard.style.display = 'block';
        } else {
            infoCard.style.display = 'none';
        }
    }

    // Auto-preencher posto ao selecionar fornecedor
    document.getElementById('fornecedor_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const nomeFornecedor = selectedOption.dataset.nome;

        if (nomeFornecedor) {
            document.getElementById('posto').value = nomeFornecedor;
        }
    });

    // Event listeners
    document.getElementById('litros').addEventListener('input', calcularTotal);
    document.getElementById('valor_litro').addEventListener('input', calcularTotal);
    document.getElementById('odometro').addEventListener('input', validarOdometro);
    document.getElementById('veiculo_id').addEventListener('change', function() {
        mostrarInfoVeiculo();
        validarOdometro();
    });

    // Validação do formulário
    document.getElementById('abastecimento-form').addEventListener('submit', function(e) {
        const odometroInput = document.getElementById('odometro');
        const veiculoSelect = document.getElementById('veiculo_id');

        if (veiculoSelect.value && odometroInput.value) {
            const selectedOption = veiculoSelect.options[veiculoSelect.selectedIndex];
            const kmAtual = parseInt(selectedOption.dataset.km) || 0;
            const odometroInformado = parseInt(odometroInput.value) || 0;

            if (odometroInformado < kmAtual) {
                if (!confirm('O odômetro informado é menor que o registrado. Deseja continuar mesmo assim?')) {
                    e.preventDefault();
                    return false;
                }
            }
        }
    });

    // Inicializar se já houver valores
    calcularTotal();
    mostrarInfoVeiculo();
    validarOdometro();
});
</script>
{% endblock %}