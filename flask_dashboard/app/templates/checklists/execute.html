{% extends "base.html" %}

{% block title %}Executar Checklist #{{ checklist.id }} - Transpontual{% endblock %}

{% block extra_css %}
<style>
    /* Auto-save indicator */
    .auto-save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateX(100%);
    }

    .auto-save-indicator.show {
        opacity: 1;
        transform: translateX(0);
    }

    .auto-save-indicator.saving {
        background: #17a2b8;
        color: white;
    }

    .auto-save-indicator.saved {
        background: #28a745;
        color: white;
    }

    .auto-save-indicator.error {
        background: #dc3545;
        color: white;
    }

    /* Keyboard shortcuts help */
    .shortcuts-help {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .shortcuts-help.show {
        opacity: 1;
    }
    .checklist-header {
        background: linear-gradient(135deg, #008195 0%, #00a8c0 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .progress-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        padding: 15px 0;
        border-bottom: 2px solid #f8f9fa;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .progress-enhanced {
        position: relative;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-enhanced .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 4px;
        transition: width 0.5s ease;
        position: relative;
    }

    .progress-enhanced .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .checklist-content {
        margin-top: 100px;
    }

    .item-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
        margin-bottom: 20px;
    }

    .item-card.answered { border-left-color: #28a745; }
    .item-card.answered-nok { border-left-color: #dc3545; }
    .item-card.answered-na { border-left-color: #6c757d; }

    .item-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .severity-alta {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
    }

    .severity-media {
        background: linear-gradient(135deg, #feca57, #ff9ff3);
        color: white;
    }

    .severity-baixa {
        background: linear-gradient(135deg, #48dbfb, #0abde3);
        color: white;
    }

    .answer-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 15px 0;
    }

    .answer-btn {
        flex: 1;
        min-width: 100px;
        padding: 12px;
        border: 2px solid transparent;
        border-radius: 8px;
        background: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        text-align: center;
        position: relative;
    }

    .answer-btn:focus {
        outline: 3px solid rgba(0,123,255,0.25);
        z-index: 10;
    }

    .answer-btn .keyboard-hint {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #495057;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
    }

    .answer-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    .answer-btn.selected-ok {
        background: linear-gradient(135deg, #00b894, #00a085);
        color: white;
        border-color: #00a085;
    }

    .answer-btn.selected-nok {
        background: linear-gradient(135deg, #e17055, #d63031);
        color: white;
        border-color: #d63031;
    }

    .answer-btn.selected-na {
        background: linear-gradient(135deg, #636e72, #2d3436);
        color: white;
        border-color: #2d3436;
    }

    .observations-area {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
    }

    .observations-area.show { display: block; }

    .quick-observations {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
    }

    .quick-obs-btn {
        padding: 6px 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .quick-obs-btn:hover { background: #e9ecef; }
    .quick-obs-btn.selected { background: #007bff; color: white; }

    .signature-pad {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        margin: 20px 0;
        position: relative;
    }

    .finish-section {
        background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-top: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
    }

    .floating-save {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        opacity: 0;
        transform: scale(0.5);
        transition: all 0.3s ease;
    }

    .floating-save.show {
        opacity: 1;
        transform: scale(1);
    }

    @media (max-width: 768px) {
        .answer-buttons { flex-direction: column; }
        .answer-btn { min-width: 100%; }
        .stats-grid { grid-template-columns: 1fr 1fr; }
        .floating-save { bottom: 80px; }

        /* Ajustar bot√µes de finaliza√ß√£o em mobile */
        .finish-buttons {
            flex-direction: column !important;
            gap: 10px;
        }

        .finish-buttons .btn {
            width: 100% !important;
            margin: 0 !important;
        }

        .item-navigation {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            margin: 0;
            z-index: 999;
        }
    }

    .item-navigation {
        position: sticky;
        bottom: 20px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 50px;
        padding: 10px 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header do Checklist -->
<div class="checklist-header">
    <div class="row align-items-center">
        <div class="col-md-6">
            <div class="d-flex align-items-center">
                <a href="/checklists" class="btn btn-outline-secondary btn-sm me-3" title="Voltar para lista">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-clipboard-check me-2"></i>
                        Checklist #{{ checklist.id }}
                    </h2>
                </div>
            </div>
            <p class="mb-0 opacity-75">
                <i class="bi bi-truck me-2"></i>{{ checklist.veiculo_placa }} - {{ checklist.veiculo_modelo }}
                <span class="ms-3">
                    <i class="bi bi-person me-1"></i>{{ checklist.motorista_nome }}
                </span>
            </p>
        </div>

        <div class="col-md-6 text-end">
            <div class="d-flex justify-content-end align-items-center">
                <span class="badge bg-light text-dark me-2 fs-6">
                    {{ checklist.tipo.upper() }}
                </span>
                <span class="badge bg-{{ 'warning' if checklist.status == 'em_andamento' else 'success' }} fs-6">
                    {{ checklist.status.replace('_', ' ').title() }}
                </span>
            </div>

            <div class="mt-2">
                <small class="opacity-75">
                    Iniciado em: {{ checklist.dt_inicio|datetime }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Progresso -->
<div class="progress-container">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Progresso do Checklist</span>
                    <span id="progress-text">0/{{ checklist.itens|length }} itens</span>
                </div>
                <div class="progress-enhanced">
                    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="scrollToNext()">
                    <i class="bi bi-arrow-down me-1"></i>Pr√≥ximo
                </button>
                <button class="btn btn-primary btn-sm" onclick="saveProgress()">
                    <i class="bi bi-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auto-save Indicator -->
<div id="autoSaveIndicator" class="auto-save-indicator">
    <i class="bi bi-cloud-arrow-up me-1"></i>
    <span id="autoSaveText">Salvando...</span>
</div>

<!-- Keyboard Shortcuts Help -->
<div id="shortcutsHelp" class="shortcuts-help">
    <strong>Atalhos:</strong> 1=OK | 2=NOK | 3=N/A | Tab=Pr√≥ximo | Ctrl+S=Salvar | Ctrl+F=Finalizar
</div>

<!-- Itens do Checklist -->
<div class="container-fluid checklist-content">
    <form id="checklistForm">
        <input type="hidden" name="checklist_id" value="{{ checklist.id }}">

        {% for item in checklist.itens %}
        <div class="card item-card" id="item-{{ item.id }}" data-item-id="{{ item.id }}">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1">
                            <span class="badge bg-secondary me-2">{{ item.ordem }}</span>
                            {{ item.descricao }}
                        </h6>

                        <div class="d-flex gap-2 mt-2">
                            <span class="badge severity-{{ item.severidade }}">
                                <i class="bi bi-{{ 'exclamation-triangle-fill' if item.severidade == 'alta' else 'exclamation-circle-fill' if item.severidade == 'media' else 'info-circle-fill' }} me-1"></i>
                                {{ item.severidade.title() }}
                            </span>

                            {% if item.bloqueia_viagem %}
                            <span class="badge bg-danger">
                                <i class="bi bi-shield-exclamation me-1"></i>Bloqueante
                            </span>
                            {% endif %}

                            {% if item.exige_foto %}
                            <span class="badge bg-info">
                                <i class="bi bi-camera me-1"></i>Requer Foto
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-link btn-sm" onclick="toggleItemHelp({{ item.id }})">
                            <i class="bi bi-question-circle"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <!-- Bot√µes de Resposta -->
                <div class="answer-buttons">
                    <div class="answer-btn" data-value="ok" onclick="selectAnswer({{ item.id }}, 'ok')" tabindex="0">
                        <span class="keyboard-hint">1</span>
                        <i class="bi bi-check-circle me-2"></i>
                        <div>OK</div>
                        <small class="d-block">Conforme</small>
                    </div>

                    <div class="answer-btn" data-value="nao_ok" onclick="selectAnswer({{ item.id }}, 'nao_ok')" tabindex="0">
                        <span class="keyboard-hint">2</span>
                        <i class="bi bi-x-circle me-2"></i>
                        <div>N√ÉO OK</div>
                        <small class="d-block">Com defeito</small>
                    </div>

                    <div class="answer-btn" data-value="na" onclick="selectAnswer({{ item.id }}, 'na')" tabindex="0">
                        <span class="keyboard-hint">3</span>
                        <i class="bi bi-dash-circle me-2"></i>
                        <div>N/A</div>
                        <small class="d-block">N√£o se aplica</small>
                    </div>
                </div>

                <!-- √Årea de Observa√ß√µes (aparece quando N√ÉO OK) -->
                <div class="observations-area" id="obs-{{ item.id }}">
                    <h6 class="mb-3">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Descreva o problema encontrado
                    </h6>

                    <!-- Observa√ß√µes R√°pidas -->
                    <div class="quick-observations">
                        {% set quick_obs = [
                            "Desgaste excessivo",
                            "Rachadura/trinca",
                            "Vazamento",
                            "Ru√≠do anormal",
                            "Folga excessiva",
                            "Pe√ßa solta",
                            "Pe√ßa faltante",
                            "Sujeira/oxida√ß√£o",
                            "N√£o funciona",
                            "Outros"
                        ] %}

                        {% for obs in quick_obs %}
                        <span class="quick-obs-btn" onclick="selectQuickObs({{ item.id }}, '{{ obs }}')">
                            {{ obs }}
                        </span>
                        {% endfor %}
                    </div>

                    <!-- Campo de Observa√ß√£o Personalizada -->
                    <textarea
                        class="form-control"
                        rows="3"
                        placeholder="Descreva com detalhes o problema encontrado..."
                        id="obs-text-{{ item.id }}"
                        name="observacao_{{ item.id }}">
                    </textarea>

                    <!-- Prioridade da Corre√ß√£o -->
                    <div class="mt-3">
                        <label class="form-label">Prioridade para corre√ß√£o:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="priority_{{ item.id }}" id="urgent_{{ item.id }}" value="urgente">
                            <label class="btn btn-outline-danger" for="urgent_{{ item.id }}">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>Urgente
                            </label>

                            <input type="radio" class="btn-check" name="priority_{{ item.id }}" id="normal_{{ item.id }}" value="normal" checked>
                            <label class="btn btn-outline-warning" for="normal_{{ item.id }}">
                                <i class="bi bi-clock me-1"></i>Normal
                            </label>

                            <input type="radio" class="btn-check" name="priority_{{ item.id }}" id="low_{{ item.id }}" value="baixa">
                            <label class="btn btn-outline-info" for="low_{{ item.id }}">
                                <i class="bi bi-calendar me-1"></i>Baixa
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Help/Instru√ß√µes (colaps√°vel) -->
                <div class="collapse mt-3" id="help-{{ item.id }}">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-lightbulb me-2"></i>Como verificar:</h6>
                        <p class="mb-0">
                            {% if 'pneu' in item.descricao.lower() %}
                                Verifique a press√£o, desgaste da banda de rodagem, exist√™ncia de cortes, furos ou deforma√ß√µes.
                            {% elif '√≥leo' in item.descricao.lower() %}
                                Verificar n√≠vel atrav√©s da vareta, observar cor e consist√™ncia. Procurar vazamentos.
                            {% elif 'freio' in item.descricao.lower() %}
                                Verificar funcionamento, ru√≠dos anormais, e n√≠vel do flu√≠do de freio.
                            {% elif 'luz' in item.descricao.lower() or 'farol' in item.descricao.lower() %}
                                Testar o funcionamento de todas as luzes: far√≥is, lanternas, pisca-alerta, freio.
                            {% else %}
                                Inspecionar visualmente o item, verificando seu estado geral e funcionamento adequado.
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Se√ß√£o de Finaliza√ß√£o -->
        <div class="finish-section" id="finishSection" style="display: none;">
            <h4 class="mb-4">
                <i class="bi bi-flag-checkered me-2"></i>
                Finalizar Checklist
            </h4>

            <!-- Estat√≠sticas do Checklist -->
            <div class="stats-grid">
                <div class="stat-item">
                    <h5 id="total-items">0</h5>
                    <small>Total de Itens</small>
                </div>
                <div class="stat-item">
                    <h5 id="ok-items">0</h5>
                    <small>Conformes</small>
                </div>
                <div class="stat-item">
                    <h5 id="nok-items">0</h5>
                    <small>Com Defeito</small>
                </div>
                <div class="stat-item">
                    <h5 id="na-items">0</h5>
                    <small>N√£o se Aplica</small>
                </div>
            </div>

            <!-- Campos de Finaliza√ß√£o -->
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Od√¥metro Final (km)</label>
                    <input type="number" class="form-control" name="odometro_fim" min="0" step="1"
                           placeholder="Digite a quilometragem atual">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Status do Ve√≠culo</label>
                    <select class="form-select" name="status_veiculo">
                        <option value="liberado">Liberado para Uso</option>
                        <option value="atencao">Aten√ß√£o - Defeitos Menores</option>
                        <option value="manutencao">Necessita Manuten√ß√£o</option>
                        <option value="bloqueado">Bloqueado - N√£o Usar</option>
                    </select>
                </div>
            </div>

            <!-- Observa√ß√µes Gerais -->
            <div class="mt-3">
                <label class="form-label">Observa√ß√µes Gerais</label>
                <textarea class="form-control" rows="4" name="observacoes_gerais"
                          placeholder="Coment√°rios adicionais sobre o checklist ou condi√ß√µes gerais do ve√≠culo..."></textarea>
            </div>

            <!-- Bot√µes de Finaliza√ß√£o -->
            <div class="mt-4 text-center finish-buttons d-flex justify-content-center">
                <button type="button" class="btn btn-light me-3" onclick="saveDraft()">
                    <i class="bi bi-save me-2"></i>Salvar Rascunho
                </button>

                <button type="button" class="btn btn-success btn-lg" onclick="finishChecklist()">
                    <i class="bi bi-check-circle me-2"></i>Finalizar Checklist
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Navega√ß√£o de Itens -->
<div class="item-navigation">
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="scrollToPrevious()">
        <i class="bi bi-chevron-up"></i>
    </button>

    <div class="d-flex align-items-center">
        <span class="badge bg-primary me-2" id="current-item">1</span>
        <span class="text-muted">de {{ checklist.itens|length }}</span>
    </div>

    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="scrollToNext()">
        <i class="bi bi-chevron-down"></i>
    </button>
</div>

<!-- Bot√£o Flutuante de Salvamento -->
<div class="floating-save" id="floatingSave">
    <button type="button" class="btn btn-success rounded-circle" onclick="saveProgress()" title="Salvar Progresso">
        <i class="bi bi-save"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
let answers = {};
let unsavedChanges = false;
let currentItemIndex = 0;
const totalItems = {{ checklist.itens|length }};

// Auto-save e performance
let autoSaveTimer;
let pendingChanges = {};
let isAutoSaving = false;
let localStorageKey = 'checklist_{{ checklist.id }}';

// Cache de elementos DOM
const domCache = {
    progressBar: null,
    progressText: null,
    autoSaveIndicator: null,
    autoSaveText: null,
    shortcutsHelp: null
};

// Fun√ß√£o utilit√°ria de debounce para otimiza√ß√£o
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Inicializar cache de elementos DOM
function initDomCache() {
    domCache.progressBar = document.getElementById('progress-bar');
    domCache.progressText = document.getElementById('progress-text');
    domCache.autoSaveIndicator = document.getElementById('autoSaveIndicator');
    domCache.autoSaveText = document.getElementById('autoSaveText');
    domCache.shortcutsHelp = document.getElementById('shortcutsHelp');
}

// Auto-save inteligente
function scheduleAutoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        if (Object.keys(pendingChanges).length > 0 && !isAutoSaving) {
            performAutoSave();
        }
    }, 2000); // 2 segundos de delay
}

async function performAutoSave() {
    if (isAutoSaving || Object.keys(pendingChanges).length === 0) return;

    isAutoSaving = true;
    showAutoSaveIndicator('saving');

    try {
        // Salvar no localStorage primeiro (backup local)
        saveToLocalStorage();

        // Salvar no servidor em lote
        const response = await fetch('/checklists/{{ checklist.id }}/items/batch', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                items: Object.entries(pendingChanges).map(([itemId, data]) => ({
                    item_id: parseInt(itemId),
                    ...data
                }))
            })
        });

        if (response.ok) {
            pendingChanges = {};
            showAutoSaveIndicator('saved');
            unsavedChanges = false;
        } else {
            throw new Error('Falha no salvamento');
        }
    } catch (error) {
        console.error('Erro no auto-save:', error);
        showAutoSaveIndicator('error');
    } finally {
        isAutoSaving = false;
    }
}

function showAutoSaveIndicator(status) {
    if (!domCache.autoSaveIndicator) return;

    const indicator = domCache.autoSaveIndicator;
    const text = domCache.autoSaveText;

    indicator.classList.remove('saving', 'saved', 'error');
    indicator.classList.add(status, 'show');

    if (text) {
        const messages = {
            saving: 'Salvando...',
            saved: 'Salvo automaticamente',
            error: 'Erro no salvamento'
        };
        text.textContent = messages[status];
    }

    // Esconder ap√≥s 3 segundos (exceto para saving)
    if (status !== 'saving') {
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 3000);
    }
}

// Cache local para backup
function saveToLocalStorage() {
    const data = {
        answers,
        timestamp: Date.now(),
        pendingChanges
    };
    localStorage.setItem(localStorageKey, JSON.stringify(data));
}

function loadFromLocalStorage() {
    try {
        const data = localStorage.getItem(localStorageKey);
        if (data) {
            const parsed = JSON.parse(data);
            // S√≥ carregar se for recente (√∫ltimas 24h)
            if (Date.now() - parsed.timestamp < 24 * 60 * 60 * 1000) {
                return parsed;
            }
        }
    } catch (error) {
        console.warn('Erro ao carregar do localStorage:', error);
    }
    return null;
}

// Atalhos de teclado
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl+S para salvar
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveProgress();
            return;
        }

        // Ctrl+F para finalizar
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            if (confirm('Finalizar checklist?')) {
                finishChecklist();
            }
            return;
        }

        // H para mostrar/esconder ajuda
        if (e.key === 'h' || e.key === 'H') {
            toggleShortcutsHelp();
            return;
        }

        // Navega√ß√£o entre itens
        if (e.key === 'Tab' && !e.shiftKey) {
            e.preventDefault();
            scrollToNext();
            return;
        }

        if (e.key === 'Tab' && e.shiftKey) {
            e.preventDefault();
            scrollToPrevious();
            return;
        }

        // Respostas r√°pidas (1, 2, 3)
        const currentItem = getCurrentVisibleItem();
        if (currentItem) {
            const itemId = currentItem.dataset.itemId;

            if (e.key === '1') {
                e.preventDefault();
                selectAnswer(parseInt(itemId), 'ok');
            } else if (e.key === '2') {
                e.preventDefault();
                selectAnswer(parseInt(itemId), 'nao_ok');
            } else if (e.key === '3') {
                e.preventDefault();
                selectAnswer(parseInt(itemId), 'na');
            }
        }
    });
}

function getCurrentVisibleItem() {
    const items = document.querySelectorAll('.item-card');
    const viewportCenter = window.innerHeight / 2;

    for (let item of items) {
        const rect = item.getBoundingClientRect();
        if (rect.top <= viewportCenter && rect.bottom >= viewportCenter) {
            return item;
        }
    }
    return items[0]; // fallback para o primeiro
}

function toggleShortcutsHelp() {
    if (domCache.shortcutsHelp) {
        domCache.shortcutsHelp.classList.toggle('show');
    }
}


// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    initDomCache();
    setupKeyboardShortcuts();

    // Tentar carregar dados locais primeiro
    const localData = loadFromLocalStorage();
    if (localData && localData.answers) {
        answers = localData.answers;
        // Aplicar respostas salvas localmente
        Object.entries(answers).forEach(([itemId, value]) => {
            selectAnswer(parseInt(itemId), value, false);
        });
    }

    loadExistingAnswers();
    updateProgress();

    // Mostrar ajuda de atalhos por 5 segundos
    setTimeout(() => {
        if (domCache.shortcutsHelp) {
            domCache.shortcutsHelp.classList.add('show');
            setTimeout(() => {
                domCache.shortcutsHelp.classList.remove('show');
            }, 5000);
        }
    }, 1000);

    // Carregar respostas j√° salvas
    {% for item in checklist.itens %}
        {% if checklist.respostas %}
            {% for resposta in checklist.respostas %}
                {% if resposta.item_id == item.id %}
                    selectAnswer({{ item.id }}, '{{ resposta.valor }}', false);
                    {% if resposta.observacao %}
                        document.getElementById('obs-text-{{ item.id }}').value = '{{ resposta.observacao }}';
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}

    updateProgress();
});

// Selecionar resposta
function selectAnswer(itemId, value, save = true) {
    answers[itemId] = value;

    // Usar requestAnimationFrame para otimizar atualiza√ß√µes do DOM
    requestAnimationFrame(() => {
        // Cache dos elementos para evitar m√∫ltiplas queries
        const itemCard = document.getElementById(`item-${itemId}`);
        if (!itemCard) return;

        const buttons = itemCard.querySelectorAll('.answer-btn');
        const obsArea = document.getElementById(`obs-${itemId}`);

        // Batch DOM updates
        buttons.forEach(btn => {
            const isSelected = btn.dataset.value === value;
            btn.classList.remove('selected-ok', 'selected-nok', 'selected-na');
            if (isSelected) {
                btn.classList.add(`selected-${value.replace('_', '-')}`);
            }
        });

        // Atualizar classe do card em uma √∫nica opera√ß√£o
        itemCard.className = itemCard.className.replace(/\banswered(-nok|-na)?\b/g, '');
        if (value === 'ok') itemCard.classList.add('answered');
        else if (value === 'nao_ok') itemCard.classList.add('answered-nok');
        else itemCard.classList.add('answered-na');

        // Mostrar/ocultar √°rea de observa√ß√µes
        if (obsArea) {
            obsArea.classList.toggle('show', value === 'nao_ok');
        }

        // Usar debounce para updateProgress
        if (!window.debouncedUpdateProgress) {
            window.debouncedUpdateProgress = debounce(updateProgress, 100);
        }
        window.debouncedUpdateProgress();
    });

    if (save) {
        unsavedChanges = true;

        // Adicionar aos pending changes para auto-save em lote
        pendingChanges[itemId] = {
            valor: value,
            observacao: document.getElementById(`obs-text-${itemId}`)?.value || null
        };

        // Salvar localmente imediatamente
        saveToLocalStorage();

        // Agendar auto-save no servidor
        scheduleAutoSave();

        showFloatingSave();
    }
}

// Selecionar observa√ß√£o r√°pida
function selectQuickObs(itemId, observation) {
    const textarea = document.getElementById(`obs-text-${itemId}`);
    if (!textarea) return;

    const currentValue = textarea.value.trim();

    // Se j√° tem texto, adicionar; sen√£o, substituir
    if (currentValue && !currentValue.includes(observation)) {
        textarea.value = currentValue + (currentValue.endsWith('.') ? ' ' : '. ') + observation;
    } else if (!currentValue) {
        textarea.value = observation;
    }

    // Usar requestAnimationFrame para otimizar atualiza√ß√µes visuais
    requestAnimationFrame(() => {
        const obsContainer = document.getElementById(`obs-${itemId}`);
        if (!obsContainer) return;

        const buttons = obsContainer.querySelectorAll('.quick-obs-btn');
        buttons.forEach(btn => {
            btn.classList.toggle('selected', btn.textContent.trim() === observation);
        });
    });

    unsavedChanges = true;
}

// Atualizar progresso com cache de elementos
function updateProgress() {
    const answered = Object.keys(answers).length;
    const percentage = Math.round((answered / totalItems) * 100);

    // Usar cache de elementos
    if (domCache.progressBar) {
        domCache.progressBar.style.width = percentage + '%';
        // Adicionar classe para anima√ß√£o se 100%
        if (percentage === 100) {
            domCache.progressBar.classList.add('completed');
        }
    }

    if (domCache.progressText) {
        domCache.progressText.textContent = `${answered}/${totalItems} itens (${percentage}%)`;
    }

    // Atualizar estat√≠sticas visuais
    updateStats();

    // Mostrar se√ß√£o de finaliza√ß√£o se todas as respostas foram dadas
    if (answered === totalItems) {
        const finishSection = document.getElementById('finishSection');
        if (finishSection) {
            finishSection.style.display = 'block';
            // Scroll suave para a se√ß√£o de finaliza√ß√£o
            setTimeout(() => {
                finishSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);
        }
        updateStats();
    }
}

// Atualizar estat√≠sticas
function updateStats() {
    const stats = { ok: 0, nok: 0, na: 0 };

    Object.values(answers).forEach(value => {
        if (value === 'ok') stats.ok++;
        else if (value === 'nao_ok') stats.nok++;
        else if (value === 'na') stats.na++;
    });

    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('ok-items').textContent = stats.ok;
    document.getElementById('nok-items').textContent = stats.nok;
    document.getElementById('na-items').textContent = stats.na;
}

// Navegar entre itens - vers√£o otimizada
function scrollToNext() {
    const items = document.querySelectorAll('.item-card');

    // Primeiro, tentar encontrar o pr√≥ximo item n√£o respondido
    for (let i = currentItemIndex; i < items.length; i++) {
        const itemId = items[i].dataset.itemId;
        if (!answers[itemId]) {
            items[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
            currentItemIndex = i;
            document.getElementById('current-item').textContent = i + 1;

            // Focar no primeiro bot√£o do item
            setTimeout(() => {
                const firstBtn = items[i].querySelector('.answer-btn');
                if (firstBtn) firstBtn.focus();
            }, 500);
            return;
        }
    }

    // Se todos respondidos, ir para a se√ß√£o de finaliza√ß√£o
    const finishSection = document.getElementById('finishSection');
    if (finishSection) {
        finishSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Mostrar se√ß√£o se ainda n√£o estiver vis√≠vel
        if (finishSection.style.display === 'none') {
            finishSection.style.display = 'block';
        }
    }
}

function scrollToPrevious() {
    console.log('‚¨ÜÔ∏è scrollToPrevious chamado', { currentItemIndex });
    const items = document.querySelectorAll('.item-card');

    if (currentItemIndex > 0) {
        currentItemIndex--;
        items[currentItemIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('current-item').textContent = currentItemIndex + 1;
        console.log('‚úÖ Navegou para item anterior:', currentItemIndex + 1);
    } else {
        console.log('‚ùå J√° est√° no primeiro item');
    }
}

// Toggle help
function toggleItemHelp(itemId) {
    const helpElement = document.getElementById(`help-${itemId}`);
    const collapse = new bootstrap.Collapse(helpElement);
    collapse.toggle();
}

// Salvar progresso
async function saveProgress() {
    console.log('üîÑ saveProgress chamado', { unsavedChanges, answers });
    if (!unsavedChanges && Object.keys(answers).length === 0) {
        console.log('‚ùå Nenhuma mudan√ßa para salvar');
        return;
    }

    const respostas = [];

    for (let [itemId, valor] of Object.entries(answers)) {
        const observacao = document.getElementById(`obs-text-${itemId}`)?.value?.trim() || null;

        respostas.push({
            item_id: parseInt(itemId),
            valor: valor,
            observacao: observacao
        });
    }

    try {
        showLoading(document.querySelector('.floating-save button'));

        const response = await fetch('/ui/checklist/answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                checklist_id: {{ checklist.id }},
                respostas: respostas
            })
        });

        if (!response.ok) throw new Error('Falha ao salvar');

        unsavedChanges = false;
        hideFloatingSave();

        // Feedback visual
        showToast('Progresso salvo com sucesso!', 'success');

    } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('Erro ao salvar progresso: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

// Finalizar checklist
async function finishChecklist() {
    // Validar se todas as respostas foram dadas
    if (Object.keys(answers).length < totalItems) {
        showToast('Responda todos os itens antes de finalizar!', 'warning');
        scrollToNext();
        return;
    }

    // Confirmar finaliza√ß√£o
    if (!confirm('Confirma a finaliza√ß√£o do checklist? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }

    try {
        // Primeiro salvar todas as respostas
        await saveProgress();

        // Depois finalizar
        const formData = new FormData(document.getElementById('checklistForm'));

        const response = await fetch('/checklists/{{ checklist.id }}/finish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                odometro_fim: parseInt(formData.get('odometro_fim')) || null,
                observacoes_gerais: formData.get('observacoes_gerais') || null
            })
        });

        if (!response.ok) throw new Error('Falha ao finalizar checklist');

        const result = await response.json();
        showToast('Checklist finalizado com sucesso! Redirecionando...', 'success');

        // Redirecionar para lista de checklists
        setTimeout(() => {
            window.location.href = '/checklists';
        }, 2000);

    } catch (error) {
        console.error('Erro ao finalizar:', error);
        showToast('Erro ao finalizar: ' + error.message, 'danger');
    }
}

// Salvar como rascunho
async function saveDraft() {
    await saveProgress();
    showToast('Rascunho salvo! Voc√™ pode continuar mais tarde.', 'info');

    setTimeout(() => {
        window.location.href = '/checklists';
    }, 2000);
}

// Utilit√°rios
function showFloatingSave() {
    document.getElementById('floatingSave').classList.add('show');
}

function hideFloatingSave() {
    document.getElementById('floatingSave').classList.remove('show');
}

function setupAutoSave() {
    // Salvar automaticamente a cada 5 minutos
    setInterval(() => {
        if (unsavedChanges) {
            saveProgress();
        }
    }, 300000);

    // Salvar antes de sair da p√°gina
    window.addEventListener('beforeunload', (e) => {
        if (unsavedChanges) {
            e.preventDefault();
            e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Deseja realmente sair?';
        }
    });
}

function loadExistingAnswers() {
    // Carregar respostas j√° salvas do backend se existirem
    // Implementado via Jinja2 template no documento ready
}

function showToast(message, type = 'info') {
    // Criar toast Bootstrap
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type}" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    // Adicionar ao container de toasts (criar se n√£o existir)
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }

    container.insertAdjacentHTML('beforeend', toastHtml);

    // Inicializar e mostrar toast
    const toastElement = container.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
}

function getToken() {
    // Implementar conforme seu sistema de autentica√ß√£o
    return localStorage.getItem('access_token') || '';
}

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case 'n': // Alt+N = Pr√≥ximo
                e.preventDefault();
                scrollToNext();
                break;
            case 'p': // Alt+P = Anterior
                e.preventDefault();
                scrollToPrevious();
                break;
            case 's': // Alt+S = Salvar
                e.preventDefault();
                saveProgress();
                break;
        }
    }
});
</script>
{% endblock %}