{% extends "base.html" %}

{% block title %}Checklists - Transpontual{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
<style>
    .filters-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
    }

    .status-em_andamento { background-color: #ffeaa7 !important; }
    .status-aprovado { background-color: #81ecec !important; }
    .status-reprovado { background-color: #fab1a0 !important; }
    .status-bloqueado { background-color: #fd79a8 !important; }

    .checklist-card {
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-radius: 12px;
    }

    .checklist-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .score-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }

    .score-excellent { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
    .score-good { background: linear-gradient(135deg, #fdcb6e, #f39c12); color: white; }
    .score-warning { background: linear-gradient(135deg, #e17055, #d63031); color: white; }
    .score-pending { background: linear-gradient(135deg, #6c5ce7, #5f3dc4); color: white; }

    .table-actions {
        min-width: 100px;
    }

    /* Responsividade da tabela */
    #checklistsTable {
        font-size: 0.875rem; /* 14px */
        line-height: 1.4;
    }

    #checklistsTable th {
        font-size: 0.8125rem; /* 13px */
        font-weight: 600;
        padding: 8px 6px;
        white-space: nowrap;
    }

    #checklistsTable td {
        padding: 8px 6px;
        vertical-align: middle;
    }

    /* Badges menores */
    #checklistsTable .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }

    /* Botões de ação menores */
    .table-actions .btn {
        padding: 4px 8px;
        font-size: 0.75rem;
    }

    /* Score circle menor */
    .score-circle {
        width: 35px;
        height: 35px;
        font-size: 10px;
        font-weight: 600;
    }

    /* Stat cards responsivas */
    .stat-card {
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-card .card-body {
        padding: 1rem;
    }

    .stat-card h6 {
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
    }

    .stat-card h3 {
        font-size: 1.5rem;
        font-weight: 700;
    }

    /* Filtros responsivos */
    .filters-card .card-body {
        padding: 1rem;
    }

    .filters-form .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .filters-form .form-select,
    .filters-form .form-control {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .filters-form .col-md-3 {
            margin-bottom: 1rem;
        }

        /* Header responsivo */
        .d-flex.justify-content-between.align-items-center.mb-4 {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 1rem;
        }

        .d-flex.justify-content-between.align-items-center.mb-4 .btn-group {
            width: 100%;
        }

        .d-flex.justify-content-between.align-items-center.mb-4 .btn-group .btn {
            flex: 1;
        }

        /* Stat cards em mobile */
        .stat-card .card-body {
            padding: 0.75rem;
        }

        .stat-card h6 {
            font-size: 0.75rem;
        }

        .stat-card h3 {
            font-size: 1.25rem;
        }

        .stat-card .fs-2 {
            font-size: 1.5rem !important;
        }

        /* Filtros em mobile */
        .filters-card .card-header {
            padding: 0.75rem 1rem;
        }

        .filters-card .card-header h5 {
            font-size: 1rem;
        }

        .filters-form .form-label {
            font-size: 0.8rem;
        }

        .filters-form .form-select,
        .filters-form .form-control {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        .filters-form .btn-group {
            flex-direction: column;
        }

        .filters-form .btn-group .btn {
            margin-bottom: 0.5rem;
            border-radius: 0.375rem !important;
        }

        /* Tabela em mobile */
        #checklistsTable {
            font-size: 0.75rem; /* 12px */
        }

        #checklistsTable th {
            font-size: 0.7rem; /* 11px */
            padding: 6px 4px;
        }

        #checklistsTable td {
            padding: 6px 4px;
        }

        .score-circle {
            width: 28px;
            height: 28px;
            font-size: 9px;
        }

        .table-actions {
            min-width: 80px;
        }

        .table-actions .btn {
            padding: 2px 6px;
            font-size: 0.7rem;
        }

        .badge {
            font-size: 0.65rem !important;
            padding: 2px 6px !important;
        }

        /* Esconder colunas menos importantes em mobile */
        #checklistsTable th:nth-child(6), /* Score */
        #checklistsTable td:nth-child(6),
        #checklistsTable th:nth-child(8), /* Fim */
        #checklistsTable td:nth-child(8) {
            display: none;
        }

        /* Ajustar header em mobile */
        .h3 {
            font-size: 1.2rem;
        }

        /* Botões de header menores */
        .btn-group .btn {
            font-size: 0.8rem;
            padding: 6px 12px;
        }
    }

    @media (max-width: 576px) {
        /* Extra small devices */
        #checklistsTable {
            font-size: 0.7rem; /* 11px */
        }

        #checklistsTable th {
            font-size: 0.65rem; /* 10px */
            padding: 4px 2px;
        }

        #checklistsTable td {
            padding: 4px 2px;
        }

        /* Esconder mais colunas em telas muito pequenas */
        #checklistsTable th:nth-child(4), /* Tipo */
        #checklistsTable td:nth-child(4),
        #checklistsTable th:nth-child(7), /* Início */
        #checklistsTable td:nth-child(7) {
            display: none;
        }

        .table-actions .btn {
            padding: 1px 4px;
            font-size: 0.65rem;
        }

        /* Stats em telas muito pequenas */
        .stat-card h3 {
            font-size: 1rem;
        }

        .stat-card .fs-2 {
            font-size: 1.25rem !important;
        }

        /* Header ainda menor */
        .h3 {
            font-size: 1.1rem;
        }

        /* Botões de ação empilhados */
        .d-flex.justify-content-between.align-items-center.mb-4 .btn-group {
            flex-direction: column;
        }

        /* Card compacto */
        .card .card-header {
            padding: 0.5rem 0.75rem;
        }

        .card .card-body {
            padding: 0.75rem;
        }

        /* Filtros colapsados por padrão em mobile */
        #filtersCollapse {
            display: none;
        }

        /* Estatísticas em linha única */
        .row.mb-4 {
            margin-bottom: 1rem !important;
        }
    }

    /* Melhorar legibilidade */
    .table-striped > tbody > tr:nth-of-type(odd) > td,
    .table-striped > tbody > tr:nth-of-type(odd) > th {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .table-hover > tbody > tr:hover > td,
    .table-hover > tbody > tr:hover > th {
        background-color: rgba(0, 123, 255, 0.075);
    }

    /* DataTables responsive */
    table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control:before {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Corrigir problemas de formatação do DataTables */
    .dataTables_wrapper {
        width: 100% !important;
        overflow-x: auto;
    }

    .dataTables_scrollHead {
        display: none !important; /* Remover header duplicado do scroll */
    }

    .dataTables_scrollBody {
        border: none !important;
    }

    /* Forçar tabela a usar largura completa */
    #checklistsTable {
        width: 100% !important;
        table-layout: auto !important;
        border-collapse: collapse !important;
    }

    /* Corrigir larguras das colunas */
    #checklistsTable th,
    #checklistsTable td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: none !important;
    }

    /* Permitir quebra em colunas específicas */
    #checklistsTable th:nth-child(2), /* Veículo */
    #checklistsTable td:nth-child(2),
    #checklistsTable th:nth-child(3), /* Motorista */
    #checklistsTable td:nth-child(3) {
        white-space: normal;
        word-wrap: break-word;
        min-width: 100px;
    }

    /* Centralizar colunas específicas */
    #checklistsTable th:nth-child(1), /* ID */
    #checklistsTable td:nth-child(1),
    #checklistsTable th:nth-child(4), /* Tipo */
    #checklistsTable td:nth-child(4),
    #checklistsTable th:nth-child(5), /* Status */
    #checklistsTable td:nth-child(5),
    #checklistsTable th:nth-child(6), /* Score */
    #checklistsTable td:nth-child(6),
    #checklistsTable th:nth-child(7), /* Início */
    #checklistsTable td:nth-child(7),
    #checklistsTable th:nth-child(8), /* Fim */
    #checklistsTable td:nth-child(8),
    #checklistsTable th:nth-child(9), /* Ações */
    #checklistsTable td:nth-child(9) {
        text-align: center;
    }

    /* Melhorar aparência em mobile */
    @media (max-width: 768px) {
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: center;
            margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            float: none;
            text-align: center;
            margin-top: 10px;
        }

        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            width: auto;
            display: inline-block;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">
            <i class="bi bi-clipboard-check text-primary me-2"></i>
            Checklists
        </h1>
        <p class="text-muted mb-0">Gerencie e monitore todos os checklists veiculares</p>
    </div>

    <div class="btn-group">
        <a href="{{ url_for('checklist_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>Novo Checklist
        </a>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
            <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                <i class="bi bi-filetype-csv me-2"></i>Exportar CSV
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportData('pdf')">
                <i class="bi bi-filetype-pdf me-2"></i>Exportar PDF
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise me-2"></i>Atualizar
            </a></li>
        </ul>
    </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mb-4" id="quick-stats">
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-white-50">Total</h6>
                        <h3 class="mb-0" id="stat-total">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clipboard-data fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-white-50">Aprovados</h6>
                        <h3 class="mb-0" id="stat-aprovados">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-white-50">Em Andamento</h6>
                        <h3 class="mb-0" id="stat-andamento">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-white-50">Reprovados</h6>
                        <h3 class="mb-0" id="stat-reprovados">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-x-circle fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Avançados -->
<div class="card filters-card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-funnel me-2"></i>Filtros
            <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true">
                <i class="bi bi-chevron-down"></i>
            </button>
        </h5>
    </div>

    <div class="collapse show" id="filtersCollapse">
        <div class="card-body">
            <form id="filtersForm" class="filters-form">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filter_status" class="form-label">Status</label>
                        <select class="form-select" id="filter_status" name="status">
                            <option value="">Todos os status</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="reprovado">Reprovado</option>
                            <option value="bloqueado">Bloqueado</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="filter_tipo" class="form-label">Tipo</label>
                        <select class="form-select" id="filter_tipo" name="tipo">
                            <option value="">Todos os tipos</option>
                            <option value="pre">Pré-viagem</option>
                            <option value="pos">Pós-viagem</option>
                            <option value="manutencao">Manutenção</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="filter_veiculo" class="form-label">Veículo</label>
                        <select class="form-select" id="filter_veiculo" name="veiculo_id">
                            <option value="">Todos os veículos</option>
                            {% for veiculo in veiculos %}
                            <option value="{{ veiculo.id }}">{{ veiculo.placa }} - {{ veiculo.modelo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="filter_motorista" class="form-label">Motorista</label>
                        <select class="form-select" id="filter_motorista" name="motorista_id">
                            <option value="">Todos os motoristas</option>
                            {% for motorista in motoristas %}
                            <option value="{{ motorista.id }}">{{ motorista.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-3">
                        <label for="filter_data_inicio" class="form-label">Data Início</label>
                        <input type="date" class="form-control" id="filter_data_inicio" name="data_inicio">
                    </div>

                    <div class="col-md-3">
                        <label for="filter_data_fim" class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="filter_data_fim" name="data_fim">
                    </div>

                    <div class="col-md-3">
                        <label for="filter_placa" class="form-label">Buscar Placa</label>
                        <input type="text" class="form-control" id="filter_placa" name="placa" placeholder="Digite a placa...">
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-search me-1"></i>Filtrar
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x me-1"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabela de Checklists -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Lista de Checklists</h5>

        </div>
    </div>

    <div class="card-body">
        <!-- View de Tabela -->
        <div id="table-view">
            <div class="table-responsive">
                <table id="checklistsTable" class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Veículo</th>
                            <th>Motorista</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Início</th>
                            <th>Fim</th>
                            <th class="table-actions">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados carregados via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading/Empty States -->
        <div id="loading-state" class="text-center py-5" style="display: none;">
            <div class="loading-spinner mx-auto mb-3"></div>
            <p class="text-muted">Carregando checklists...</p>
        </div>

        <div id="empty-state" class="text-center py-5" style="display: none;">
            <i class="bi bi-clipboard-x display-1 text-muted mb-3"></i>
            <h5 class="text-muted">Nenhum checklist encontrado</h5>
            <p class="text-muted">Tente ajustar os filtros ou criar um novo checklist.</p>
            <a href="{{ url_for('checklist_new') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Criar Primeiro Checklist
            </a>
        </div>
    </div>
</div>

<!-- Paginação -->
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination">
        <!-- Paginação será gerada via JavaScript -->
    </ul>
</nav>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
let currentView = 'table';
let currentPage = 1;
let currentFilters = {};

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    // Restaurar filtros da URL
    restoreFiltersFromURL();

    // Inicializar DataTable
    if (!$.fn.DataTable.isDataTable('#checklistsTable')) {
        initDataTable();
    }

    loadChecklists();
    loadStats();

    // Auto-refresh a cada 5 minutos
    setInterval(() => {
        if (navigator.onLine) {
            loadChecklists(false); // Não mostrar loading
            loadStats();
        }
    }, 300000);
});

// Restaurar filtros da URL
function restoreFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);

    // Restaurar valores nos campos do formulário
    for (let [key, value] of urlParams.entries()) {
        const field = document.getElementById(`filter_${key}`) || document.querySelector(`[name="${key}"]`);
        if (field) {
            field.value = value;
            if (value.trim()) {
                currentFilters[key] = value;
            }
        }
    }

    // Restaurar página
    const page = urlParams.get('page');
    if (page) {
        currentPage = parseInt(page);
    }
}


// Inicializar DataTable
function initDataTable() {
    $('#checklistsTable').DataTable({
        responsive: true,
        pageLength: window.innerWidth <= 768 ? 15 : 25,
        lengthMenu: window.innerWidth <= 768 ?
            [[10, 15, 25], [10, 15, 25]] :
            [[25, 50, 100], [25, 50, 100]],
        scrollX: false, // Desabilitar scroll horizontal
        autoWidth: false,
        columnDefs: [
            {
                targets: [8], // Ações
                orderable: false,
                width: window.innerWidth <= 768 ? '80px' : '100px',
                className: 'text-center'
            },
            {
                targets: [0], // ID
                width: '50px',
                className: 'text-center'
            },
            {
                targets: [1, 2], // Veículo, Motorista
                width: window.innerWidth <= 768 ? '120px' : '180px'
            },
            {
                targets: [3, 4], // Tipo, Status
                width: window.innerWidth <= 768 ? '80px' : '100px',
                className: 'text-center'
            },
            {
                targets: [5], // Score
                width: '60px',
                className: 'text-center'
            },
            {
                targets: [6, 7], // Datas
                width: window.innerWidth <= 768 ? '100px' : '120px',
                className: 'text-center'
            },
            // Responsividade - colunas menos importantes
            {
                targets: [5], // Score
                responsivePriority: 3
            },
            {
                targets: [7], // Fim
                responsivePriority: 4
            },
            {
                targets: [3], // Tipo
                responsivePriority: 5
            },
            {
                targets: [6], // Início
                responsivePriority: 6
            }
        ],
        language: {
            "sEmptyTable": "Nenhum dado disponível na tabela",
            "sInfo": "Mostrando _START_ até _END_ de _TOTAL_ entradas",
            "sInfoEmpty": "Mostrando 0 até 0 de 0 entradas",
            "sInfoFiltered": "(filtrado de _MAX_ entradas totais)",
            "sInfoPostFix": "",
            "sInfoThousands": ".",
            "sLengthMenu": "Mostrar _MENU_ entradas",
            "sLoadingRecords": "Carregando...",
            "sProcessing": "Processando...",
            "sSearch": "Buscar:",
            "sZeroRecords": "Nenhum resultado encontrado",
            "oPaginate": {
                "sFirst": "Primeiro",
                "sLast": "Último",
                "sNext": "Próximo",
                "sPrevious": "Anterior"
            },
            "oAria": {
                "sSortAscending": ": ative para classificar a coluna em ordem crescente",
                "sSortDescending": ": ative para classificar a coluna em ordem decrescente"
            }
        },
        order: [[6, 'desc']], // Ordenar por data início desc
        columnDefs: [
            { targets: [8], orderable: false } // Ações não ordenáveis
        ]
    });
}

// Carregar estatísticas
async function loadStats() {
    try {
        const params = new URLSearchParams(currentFilters);
        const response = await fetch(`/api/kpis?${params}`);

        if (response.ok) {
            const stats = await response.json();

            document.getElementById('stat-total').textContent = stats.total_checklists || 0;
            document.getElementById('stat-aprovados').textContent = stats.aprovados || 0;
            document.getElementById('stat-andamento').textContent = stats.em_andamento || 0;
            document.getElementById('stat-reprovados').textContent = stats.reprovados || 0;
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Carregar checklists
async function loadChecklists(showLoading = true) {
    console.log('🔄 Carregando checklists...', { currentFilters, currentPage });

    const tableView = document.getElementById('table-view');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');

    if (showLoading) {
        if (loadingState) loadingState.style.display = 'block';
        if (tableView) tableView.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
    }

    try {
        const params = new URLSearchParams({
            ...currentFilters,
            page: currentPage,
            per_page: 12
        });

        console.log('📡 Fazendo requisição para:', `/checklists/api?${params}`);
        const response = await fetch(`/checklists/api?${params}`);

        if (!response.ok) {
            console.error('❌ Erro na resposta:', response.status, response.statusText);
            throw new Error(`Falha ao carregar dados: ${response.status}`);
        }

        const data = await response.json();
        console.log('✅ Dados recebidos:', data);

        // Ensure we have a valid array
        let checklists = data.checklists || data.items || data;
        if (!Array.isArray(checklists)) {
            console.warn('API returned non-array data:', checklists);
            checklists = [];
        }

        renderChecklistTable(checklists);

        if (checklists.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
        } else {
            if (emptyState) emptyState.style.display = 'none';
        }

    } catch (error) {
        console.error('Erro ao carregar checklists:', error);
        if (tableView) {
            tableView.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Erro ao carregar checklists: ${error.message}
                </div>
            `;
        }
    } finally {
        if (loadingState) loadingState.style.display = 'none';
        if (tableView) tableView.style.display = 'block';
    }
}


// Renderizar tabela
function renderChecklistTable(checklists) {
    const tbody = document.querySelector('#checklistsTable tbody');

    // Se DataTable já existe, limpar dados mas manter estrutura
    let table;
    let wasInitialized = false;

    if ($.fn.DataTable.isDataTable('#checklistsTable')) {
        table = $('#checklistsTable').DataTable();
        table.clear();
        wasInitialized = true;
    }

    // Popula a tabela com os dados
    checklists.forEach(checklist => {
        const row = [
            `#${checklist.id}`,
            `<div>
                <strong>${checklist.veiculo_placa || 'N/A'}</strong>
                <br><small class="text-muted">${checklist.veiculo_modelo || ''}</small>
            </div>`,
            `${checklist.motorista_nome || 'N/A'}`,
            `<span class="badge bg-light text-dark">
                <i class="bi bi-${checklist.tipo === 'pre' ? 'arrow-right' : checklist.tipo === 'pos' ? 'arrow-left' : 'tools'} me-1"></i>
                ${getTipoText(checklist.tipo)}
            </span>`,
            `<span class="badge status-${checklist.status} text-dark">
                ${getStatusText(checklist.status)}
            </span>`,
            `<div class="d-flex align-items-center">
                <div class="score-circle ${getScoreClass(checklist.score_aprovacao)} me-2" style="width: 35px; height: 35px; font-size: 11px;">
                    ${checklist.score_aprovacao ? Math.round(checklist.score_aprovacao) + '%' : '-%'}
                </div>
            </div>`,
            `${formatDate(checklist.dt_inicio)}`,
            `${checklist.dt_fim ? formatDate(checklist.dt_fim) : '-'}`,
            `<div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="event.stopPropagation(); viewChecklist(${checklist.id})" title="Visualizar">
                    <i class="bi bi-eye"></i>
                </button>
                ${checklist.status === 'em_andamento' ? `
                    <button class="btn btn-outline-warning" onclick="event.stopPropagation(); continueChecklist(${checklist.id})" title="Continuar">
                        <i class="bi bi-play"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="event.stopPropagation(); finishChecklist(${checklist.id})" title="Finalizar">
                        <i class="bi bi-check-lg"></i>
                    </button>
                ` : ''}
                <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); editChecklist(${checklist.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteChecklist(${checklist.id})" title="Excluir">
                    <i class="bi bi-trash"></i>
                </button>
            </div>`
        ];

        // Adicionar linha ao DataTable
        if (wasInitialized) {
            table.row.add(row);
        } else {
            // Se não foi inicializado, adicionar ao HTML
            const tr = document.createElement('tr');
            row.forEach(cellContent => {
                const td = document.createElement('td');
                td.innerHTML = cellContent;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        }
    });

    // Redesenhar tabela se já estava inicializada
    if (wasInitialized) {
        table.draw();
    } else {
        // Inicializar DataTable se ainda não foi
        initDataTable();
    }
}

// Funções auxiliares
function getStatusText(status) {
    const statusMap = {
        'em_andamento': 'Em Andamento',
        'aprovado': 'Aprovado',
        'reprovado': 'Reprovado',
        'bloqueado': 'Bloqueado'
    };
    return statusMap[status] || status;
}

function getTipoText(tipo) {
    const tipoMap = {
        'pre': 'Pré-viagem',
        'pos': 'Pós-viagem',
        'manutencao': 'Manutenção'
    };
    return tipoMap[tipo] || tipo;
}

function getScoreClass(score) {
    if (!score) return 'score-pending';
    if (score >= 90) return 'score-excellent';
    if (score >= 70) return 'score-good';
    return 'score-warning';
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    } catch (e) {
        return dateString;
    }
}

// Ações
function applyFilters() {
    const form = document.getElementById('filtersForm');
    const formData = new FormData(form);

    currentFilters = {};
    const urlParams = new URLSearchParams();

    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            currentFilters[key] = value;
            urlParams.append(key, value);
        }
    }

    currentPage = 1;

    // Atualizar URL sem recarregar a página
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    window.history.pushState({}, '', newUrl);

    loadChecklists();
    loadStats();
}

function clearFilters() {
    document.getElementById('filtersForm').reset();
    currentFilters = {};
    currentPage = 1;

    // Limpar URL
    window.history.pushState({}, '', window.location.pathname);

    loadChecklists();
    loadStats();
}

function refreshData() {
    loadChecklists();
    loadStats();
}

function viewChecklist(id) {
    window.location.href = `/checklists/${id}`;
}

function continueChecklist(id) {
    window.location.href = `/checklists/${id}/execute`;
}

async function finishChecklist(id) {
    if (!confirm('Deseja finalizar este checklist? Esta ação não pode ser desfeita.')) {
        return;
    }

    try {
        const response = await fetch(`/checklists/${id}/finish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                odometro_fim: null // Pode ser expandido para coletar odômetro final
            })
        });

        if (response.ok) {
            alert('Checklist finalizado com sucesso!');
            loadChecklists(); // Recarregar a lista
            loadStats(); // Atualizar estatísticas
        } else {
            const error = await response.text();
            alert(`Erro ao finalizar checklist: ${error}`);
        }
    } catch (error) {
        console.error('Erro ao finalizar checklist:', error);
        alert('Erro ao finalizar checklist. Tente novamente.');
    }
}

function duplicateChecklist(id) {
    if (confirm('Deseja duplicar este checklist?')) {
        // TODO: Implementar duplicação
        alert('Funcionalidade em desenvolvimento');
    }
}

function exportChecklist(id) {
    window.open(`/reports/checklist/${id}/pdf`, '_blank');
}

function exportData(format) {
    const params = new URLSearchParams(currentFilters);
    window.open(`/reports/checklists/${format}?${params}`, '_blank');
}

async function deleteChecklist(id) {
    if (!confirm('Tem certeza que deseja excluir este checklist? Esta ação não pode ser desfeita.')) {
        return;
    }

    try {
        const response = await fetch(`/checklist/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            alert('Checklist excluído com sucesso!');
            loadChecklists(); // Recarregar a lista
            loadStats(); // Atualizar estatísticas
        } else {
            const error = await response.text();
            alert(`Erro ao excluir checklist: ${error}`);
        }
    } catch (error) {
        console.error('Erro ao excluir checklist:', error);
        alert('Erro ao excluir checklist. Tente novamente.');
    }
}

// Editar checklist
function editChecklist(id) {
    window.location.href = `/checklists/${id}/edit`;
}

// Função global para refresh (usada pelo auto-refresh do template base)
function refreshData() {
    loadChecklists(false);
    loadStats();
}

// Melhorias para mobile
document.addEventListener('DOMContentLoaded', function() {
    // Detectar se é mobile e ajustar interface
    if (window.innerWidth <= 768) {
        // Colapsar filtros por padrão em mobile
        const filtersCollapse = document.getElementById('filtersCollapse');
        if (filtersCollapse) {
            filtersCollapse.classList.remove('show');
        }

        // Ajustar DataTable para mobile
        const dataTableWrapper = document.querySelector('.dataTables_wrapper');
        if (dataTableWrapper) {
            dataTableWrapper.style.fontSize = '0.75rem';
        }
    }

    // Listener para mudanças de orientação
    window.addEventListener('orientationchange', function() {
        setTimeout(() => {
            // Redesenhar DataTable após mudança de orientação
            const table = $('#checklistsTable').DataTable();
            if (table) {
                table.columns.adjust().responsive.recalc();
            }
        }, 500);
    });

    // Listener para redimensionamento
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            const table = $('#checklistsTable').DataTable();
            if (table) {
                table.columns.adjust().responsive.recalc();
                table.draw(false); // Redesenhar sem resetar paginação
            }
        }, 250);
    });

    // Forçar ajuste da tabela após carregar dados
    $(document).on('xhr.dt', '#checklistsTable', function() {
        setTimeout(() => {
            const table = $('#checklistsTable').DataTable();
            if (table) {
                table.columns.adjust().responsive.recalc();
            }
        }, 100);
    });
});
</script>
{% endblock %}