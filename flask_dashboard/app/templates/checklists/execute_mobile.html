{% extends "base.html" %}

{% block title %}Executar Checklist{% endblock %}

{% block extra_css %}
<style>
    .checklist-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .checklist-header {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
    }

    .checklist-item {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
    }

    .item-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-close {
        color: #6b7280;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .item-close:hover {
        background: #f3f4f6;
        color: #ef4444;
    }

    .checkbox-group {
        margin-bottom: 20px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.3s ease;
    }

    .checkbox-item:last-child {
        border-bottom: none;
    }

    .checkbox-item:hover {
        background: #f9fafb;
        border-radius: 8px;
        padding-left: 8px;
        margin: 0 -8px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 15px;
        border: 2px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .checkbox-item input[type="checkbox"]:checked {
        background: #10b981;
        border-color: #10b981;
    }

    .checkbox-item label {
        font-size: 1rem;
        color: #374151;
        cursor: pointer;
        flex: 1;
        font-weight: 500;
    }

    .checkbox-item input[type="checkbox"]:checked + label {
        color: #10b981;
        font-weight: 600;
    }

    .others-field {
        margin-top: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 10px;
        border: 2px dashed #d1d5db;
    }

    .others-field.active {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .others-field textarea {
        width: 100%;
        border: none;
        background: transparent;
        resize: vertical;
        min-height: 80px;
        font-size: 0.95rem;
        color: #374151;
        padding: 10px 0;
    }

    .others-field textarea:focus {
        outline: none;
    }

    .photo-upload {
        margin-top: 20px;
        text-align: center;
    }

    .photo-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: #ef4444;
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .photo-btn:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .photo-preview {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .photo-preview img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .photo-preview img:hover {
        border-color: #3b82f6;
        transform: scale(1.05);
    }

    .navigation-buttons {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        background: white;
        padding: 15px 25px;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 1px solid #e5e7eb;
    }

    .nav-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
    }

    .nav-btn.prev {
        background: #f3f4f6;
        color: #6b7280;
    }

    .nav-btn.prev:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .nav-btn.next {
        background: #1e40af;
        color: white;
    }

    .nav-btn.next:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: #f3f4f6;
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .item-counter {
        font-size: 0.9rem;
        color: #6b7280;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .checklist-container {
            padding: 10px;
        }

        .checklist-item {
            padding: 20px;
            margin-bottom: 15px;
        }

        .item-title {
            font-size: 1.3rem;
        }

        .navigation-buttons {
            width: calc(100% - 40px);
            max-width: 400px;
        }
    }

    .completion-screen {
        text-align: center;
        padding: 50px 20px;
    }

    .completion-icon {
        font-size: 4rem;
        color: #10b981;
        margin-bottom: 20px;
    }

    .completion-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 15px;
    }

    .completion-subtitle {
        font-size: 1.1rem;
        color: #6b7280;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="checklist-container">
    <!-- Header do Checklist -->
    <div class="checklist-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1">Checklist Veicular</h1>
                <p class="mb-0 opacity-75">
                    Veículo: <strong id="vehicle-plate">ABC-1234</strong> |
                    Tipo: <strong id="checklist-type">Saída</strong>
                </p>
            </div>
            <div class="text-end">
                <div class="item-counter">
                    <span id="current-item">1</span> / <span id="total-items">10</span>
                </div>
            </div>
        </div>

        <!-- Barra de Progresso -->
        <div class="progress-bar mt-3">
            <div class="progress-fill" id="progress-fill" style="width: 10%"></div>
        </div>
    </div>

    <!-- Container dos Itens -->
    <div id="checklist-items">
        <!-- Item será inserido dinamicamente -->
    </div>

    <!-- Tela de Finalização -->
    <div id="completion-screen" class="completion-screen" style="display: none;">
        <div class="completion-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2 class="completion-title">Checklist Concluído!</h2>
        <p class="completion-subtitle">
            Todas as verificações foram realizadas com sucesso.<br>
            Os dados foram salvos no sistema.
        </p>
        <div class="d-flex gap-3 justify-content-center">
            <a href="{{ url_for('checklists_list') }}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> Ver Checklists
            </a>
            <button class="btn btn-primary" onclick="startNewChecklist()">
                <i class="fas fa-plus"></i> Novo Checklist
            </button>
        </div>
    </div>

    <!-- Botões de Navegação -->
    <div class="navigation-buttons" id="navigation-buttons">
        <button class="nav-btn prev" id="prev-btn" onclick="previousItem()" style="display: none;">
            <i class="fas fa-arrow-left"></i> Anterior
        </button>
        <button class="nav-btn next" id="next-btn" onclick="nextItem()">
            Próximo <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- Modal para Visualizar Foto -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Foto do Problema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-photo" src="" alt="Foto" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-danger" onclick="removePhoto()">
                    <i class="fas fa-trash"></i> Remover Foto
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados completos do checklist conforme especificação
const checklistData = {
    vehicle: "ABC-1234",
    type: "Saída",
    items: [
        // Sistema de Iluminação
        {
            id: 1,
            category: "Sistema de Iluminação",
            title: "Farol",
            options: [
                { id: "lanterna_quebrada", label: "Lanterna quebrada" },
                { id: "fora_de_foco", label: "Fora de foco" },
                { id: "lampada_queimada", label: "Lâmpada queimada" }
            ]
        },
        {
            id: 2,
            category: "Sistema de Iluminação",
            title: "Luz de ré",
            options: [
                { id: "nao_acende", label: "Não acende" },
                { id: "intermitente", label: "Intermitente" },
                { id: "lampada_queimada", label: "Lâmpada queimada" }
            ]
        },
        {
            id: 3,
            category: "Sistema de Iluminação",
            title: "Luz de freio",
            options: [
                { id: "nao_acende", label: "Não acende" },
                { id: "so_um_lado", label: "Só de um lado" },
                { id: "lampada_queimada", label: "Lâmpada queimada" }
            ]
        },
        {
            id: 4,
            category: "Sistema de Iluminação",
            title: "Setas/Pisca alerta",
            options: [
                { id: "nao_funciona", label: "Não funciona" },
                { id: "so_um_lado", label: "Só um lado" },
                { id: "lampada_queimada", label: "Lâmpada queimada" }
            ]
        },
        {
            id: 5,
            category: "Sistema de Iluminação",
            title: "Lanterna traseira/dianteira",
            options: [
                { id: "quebrada", label: "Quebrada" },
                { id: "nao_acende", label: "Não acende" },
                { id: "fume_irregular", label: "Fumê irregular" }
            ]
        },

        // Pneus e Rodas
        {
            id: 6,
            category: "Pneus e Rodas",
            title: "Pneus",
            options: [
                { id: "desgaste_irregular", label: "Desgaste irregular" },
                { id: "pneus_carecas", label: "Pneus carecas" },
                { id: "calibragem_baixa", label: "Calibragem baixa" },
                { id: "bolhas_deformacoes", label: "Bolhas/deformações" }
            ]
        },
        {
            id: 7,
            category: "Pneus e Rodas",
            title: "Estepe",
            options: [
                { id: "ausente", label: "Ausente" },
                { id: "calibragem_baixa", label: "Calibragem baixa" },
                { id: "danificado", label: "Danificado" }
            ]
        },
        {
            id: 8,
            category: "Pneus e Rodas",
            title: "Rodas",
            options: [
                { id: "parafusos_soltos", label: "Parafusos soltos" },
                { id: "trincadas_amassadas", label: "Trincadas/amassadas" },
                { id: "ferrugem_excessiva", label: "Ferrugem excessiva" }
            ]
        },

        // Freios e Suspensão
        {
            id: 9,
            category: "Freios e Suspensão",
            title: "Freios",
            options: [
                { id: "pastilhas_gastas", label: "Pastilhas gastas" },
                { id: "ruido_ao_frear", label: "Ruído ao frear" },
                { id: "pedal_baixo_duro", label: "Pedal baixo/duro" }
            ]
        },
        {
            id: 10,
            category: "Freios e Suspensão",
            title: "Suspensão",
            options: [
                { id: "amortecedor_vazamento", label: "Amortecedor com vazamento" },
                { id: "barulho_buracos", label: "Barulho em buracos" },
                { id: "mola_quebrada", label: "Mola quebrada" }
            ]
        },

        // Motor e Fluídos
        {
            id: 11,
            category: "Motor e Fluídos",
            title: "Óleo do motor",
            options: [
                { id: "nivel_baixo", label: "Nível baixo" },
                { id: "vazamento", label: "Vazamento" },
                { id: "oleo_vencido_escuro", label: "Óleo vencido/escuro" }
            ]
        },
        {
            id: 12,
            category: "Motor e Fluídos",
            title: "Água do radiador",
            options: [
                { id: "nivel_baixo", label: "Nível baixo" },
                { id: "vazamento", label: "Vazamento" },
                { id: "reservatorio_rachado", label: "Reservatório rachado" }
            ]
        },
        {
            id: 13,
            category: "Motor e Fluídos",
            title: "Freio de mão",
            options: [
                { id: "nao_segura", label: "Não segura" },
                { id: "curso_muito_alto", label: "Curso muito alto" },
                { id: "cabo_frouxo", label: "Cabo frouxo" }
            ]
        },

        // Estrutura e Segurança
        {
            id: 14,
            category: "Estrutura e Segurança",
            title: "Cintos de segurança",
            options: [
                { id: "ausente", label: "Ausente" },
                { id: "rasgado_danificado", label: "Rasgado/danificado" },
                { id: "travamento_falho", label: "Travamento falho" }
            ]
        },
        {
            id: 15,
            category: "Estrutura e Segurança",
            title: "Retrovisores",
            options: [
                { id: "quebrado", label: "Quebrado" },
                { id: "solto", label: "Solto" },
                { id: "vidro_trincado", label: "Vidro trincado" }
            ]
        },
        {
            id: 16,
            category: "Estrutura e Segurança",
            title: "Vidros e para-brisa",
            options: [
                { id: "trincado", label: "Trincado" },
                { id: "quebrado", label: "Quebrado" },
                { id: "desembacador_nao_funciona", label: "Desembaçador não funciona" }
            ]
        },
        {
            id: 17,
            category: "Estrutura e Segurança",
            title: "Extintor de incêndio",
            options: [
                { id: "ausente", label: "Ausente" },
                { id: "vencido", label: "Vencido" },
                { id: "pressao_baixa", label: "Pressão baixa" }
            ]
        },

        // Itens Internos (Cabine)
        {
            id: 18,
            category: "Itens Internos",
            title: "Painel",
            options: [
                { id: "luz_alerta_acesa", label: "Luz de alerta acesa" },
                { id: "marcadores_nao_funcionam", label: "Marcadores não funcionam" },
                { id: "painel_sem_iluminacao", label: "Painel sem iluminação" }
            ]
        },
        {
            id: 19,
            category: "Itens Internos",
            title: "Buzina",
            options: [
                { id: "nao_funciona", label: "Não funciona" },
                { id: "som_fraco", label: "Som fraco" },
                { id: "travada", label: "Travada" }
            ]
        },
        {
            id: 20,
            category: "Itens Internos",
            title: "Bancos",
            options: [
                { id: "rasgados_danificados", label: "Rasgados/danificados" },
                { id: "sem_ajuste", label: "Sem ajuste" },
                { id: "soltos", label: "Soltos" }
            ]
        },
        {
            id: 21,
            category: "Itens Internos",
            title: "Ar-condicionado/Ventilação",
            options: [
                { id: "nao_funciona", label: "Não funciona" },
                { id: "saida_ar_fraca", label: "Saída de ar fraca" },
                { id: "ruido_anormal", label: "Ruído anormal" }
            ]
        },

        // Itens de Carga e Acessórios
        {
            id: 22,
            category: "Itens de Carga",
            title: "Carroceria/Baú",
            options: [
                { id: "portas_soltas", label: "Portas soltas" },
                { id: "fechaduras_quebradas", label: "Fechaduras quebradas" },
                { id: "estrutura_danificada", label: "Estrutura danificada" }
            ]
        },
        {
            id: 23,
            category: "Itens de Carga",
            title: "Cintas de amarração",
            options: [
                { id: "ausentes", label: "Ausentes" },
                { id: "rasgadas", label: "Rasgadas" },
                { id: "sem_trava", label: "Sem trava" }
            ]
        },
        {
            id: 24,
            category: "Itens de Carga",
            title: "Tacógrafo",
            options: [
                { id: "nao_funciona", label: "Não funciona" },
                { id: "disco_cartao_ausente", label: "Disco/cartão ausente" },
                { id: "leituras_incorretas", label: "Leituras incorretas" }
            ]
        },
        {
            id: 25,
            category: "Itens de Carga",
            title: "Placas e adesivos obrigatórios",
            options: [
                { id: "ausentes", label: "Ausentes" },
                { id: "ilegiveis", label: "Ilegíveis" },
                { id: "mal_fixados", label: "Mal fixados" }
            ]
        }
    ]
};

let currentItemIndex = 0;
let responses = {};
let photos = {};

// Inicializar checklist
$(document).ready(function() {
    initializeChecklist();
    showCurrentItem();
});

function initializeChecklist() {
    document.getElementById('vehicle-plate').textContent = checklistData.vehicle;
    document.getElementById('checklist-type').textContent = checklistData.type;
    document.getElementById('total-items').textContent = checklistData.items.length;

    // Inicializar respostas
    checklistData.items.forEach(item => {
        responses[item.id] = {
            selected: [],
            others: '',
            photos: []
        };
    });
}

function showCurrentItem() {
    const item = checklistData.items[currentItemIndex];
    const container = document.getElementById('checklist-items');

    // Atualizar contador e progresso
    document.getElementById('current-item').textContent = currentItemIndex + 1;
    const progress = ((currentItemIndex + 1) / checklistData.items.length) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';

    // Criar HTML do item
    const itemHtml = `
        <div class="checklist-item" id="item-${item.id}">
            <div class="item-title">
                <span>${item.title}</span>
                <span class="item-close" onclick="skipItem()">×</span>
            </div>

            <div class="checkbox-group">
                ${item.options.map(option => `
                    <div class="checkbox-item">
                        <input type="checkbox"
                               id="option-${option.id}"
                               value="${option.id}"
                               ${responses[item.id].selected.includes(option.id) ? 'checked' : ''}
                               onchange="updateResponse('${item.id}', this)">
                        <label for="option-${option.id}">${option.label}</label>
                    </div>
                `).join('')}
            </div>

            <div class="others-field ${responses[item.id].others ? 'active' : ''}">
                <label style="font-weight: 600; color: #374151; margin-bottom: 10px; display: block;">Outros</label>
                <textarea placeholder="Descreva outros problemas encontrados..."
                          onchange="updateOthers('${item.id}', this.value)"
                          oninput="toggleOthersField(this)">${responses[item.id].others}</textarea>
            </div>

            <div class="photo-upload">
                <button class="photo-btn" onclick="addPhoto('${item.id}')">
                    <i class="fas fa-camera"></i>
                    Adicionar foto do problema
                </button>
                <input type="file" id="photo-input-${item.id}" accept="image/*" style="display: none;"
                       onchange="handlePhotoUpload('${item.id}', this)">

                <div class="photo-preview" id="photo-preview-${item.id}">
                    ${responses[item.id].photos.map((photo, index) => `
                        <img src="${photo}" alt="Foto ${index + 1}"
                             onclick="viewPhoto('${photo}', '${item.id}', ${index})">
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    container.innerHTML = itemHtml;

    // Atualizar botões de navegação
    updateNavigationButtons();
}

function updateResponse(itemId, checkbox) {
    const item = responses[itemId];

    if (checkbox.checked) {
        if (!item.selected.includes(checkbox.value)) {
            item.selected.push(checkbox.value);
        }
    } else {
        item.selected = item.selected.filter(val => val !== checkbox.value);
    }

    console.log('Resposta atualizada:', itemId, item);
}

function updateOthers(itemId, value) {
    responses[itemId].others = value;
    console.log('Outros atualizado:', itemId, value);
}

function toggleOthersField(textarea) {
    const field = textarea.closest('.others-field');
    if (textarea.value.trim()) {
        field.classList.add('active');
    } else {
        field.classList.remove('active');
    }
}

function addPhoto(itemId) {
    document.getElementById(`photo-input-${itemId}`).click();
}

function handlePhotoUpload(itemId, input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const photoUrl = e.target.result;
        responses[itemId].photos.push(photoUrl);

        // Atualizar preview
        const preview = document.getElementById(`photo-preview-${itemId}`);
        const imgElement = document.createElement('img');
        imgElement.src = photoUrl;
        imgElement.alt = `Foto ${responses[itemId].photos.length}`;
        imgElement.onclick = () => viewPhoto(photoUrl, itemId, responses[itemId].photos.length - 1);
        preview.appendChild(imgElement);

        console.log('Foto adicionada:', itemId, photoUrl.substring(0, 50) + '...');
    };
    reader.readAsDataURL(file);
}

function viewPhoto(photoUrl, itemId, index) {
    document.getElementById('modal-photo').src = photoUrl;
    window.currentPhotoData = { itemId, index };

    const modal = new bootstrap.Modal(document.getElementById('photoModal'));
    modal.show();
}

function removePhoto() {
    if (!window.currentPhotoData) return;

    const { itemId, index } = window.currentPhotoData;
    responses[itemId].photos.splice(index, 1);

    // Atualizar exibição
    showCurrentItem();

    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('photoModal'));
    modal.hide();

    console.log('Foto removida:', itemId, index);
}

function nextItem() {
    if (currentItemIndex < checklistData.items.length - 1) {
        currentItemIndex++;
        showCurrentItem();
    } else {
        completeChecklist();
    }
}

function previousItem() {
    if (currentItemIndex > 0) {
        currentItemIndex--;
        showCurrentItem();
    }
}

function skipItem() {
    // Limpar respostas do item atual
    const itemId = checklistData.items[currentItemIndex].id;
    responses[itemId] = {
        selected: [],
        others: '',
        photos: []
    };

    nextItem();
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    // Botão anterior
    if (currentItemIndex > 0) {
        prevBtn.style.display = 'inline-flex';
    } else {
        prevBtn.style.display = 'none';
    }

    // Botão próximo
    if (currentItemIndex < checklistData.items.length - 1) {
        nextBtn.innerHTML = 'Próximo <i class="fas fa-arrow-right"></i>';
    } else {
        nextBtn.innerHTML = 'Finalizar <i class="fas fa-check"></i>';
    }
}

function completeChecklist() {
    console.log('Checklist finalizado:', responses);

    // Salvar no backend
    saveChecklist().then(() => {
        // Mostrar tela de conclusão
        document.getElementById('checklist-items').style.display = 'none';
        document.getElementById('navigation-buttons').style.display = 'none';
        document.getElementById('completion-screen').style.display = 'block';
    });
}

async function saveChecklist() {
    try {
        const checklistData = {
            vehicle: document.getElementById('vehicle-plate').textContent,
            type: document.getElementById('checklist-type').textContent,
            responses: responses,
            timestamp: new Date().toISOString()
        };

        const response = await fetch('{{ config.API_BASE_URL }}/api/v1/checklist/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
            },
            body: JSON.stringify(checklistData)
        });

        if (!response.ok) {
            throw new Error('Erro ao salvar checklist');
        }

        console.log('Checklist salvo com sucesso');

    } catch (error) {
        console.error('Erro ao salvar checklist:', error);
        alert('Erro ao salvar checklist. Tente novamente.');
    }
}

function startNewChecklist() {
    // Reset dados
    currentItemIndex = 0;
    responses = {};
    photos = {};

    // Reinicializar
    initializeChecklist();

    // Mostrar primeira tela
    document.getElementById('checklist-items').style.display = 'block';
    document.getElementById('navigation-buttons').style.display = 'flex';
    document.getElementById('completion-screen').style.display = 'none';

    showCurrentItem();
}
</script>
{% endblock %}