{% extends "base.html" %}

{% block title %}Relatório de Abastecimentos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 mb-0 text-gray-800">Relatório de Abastecimentos</h1>
        <div>
            <div class="btn-group" role="group" aria-label="Exportar">
                <a href="{{ url_for('reports_abastecimentos_csv', **request.args) }}"
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-csv"></i> CSV
                </a>
                <a href="{{ url_for('reports_abastecimentos_excel', **request.args) }}"
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Excel
                </a>
                <a href="{{ url_for('reports_abastecimentos_pdf', **request.args) }}"
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                </a>
            </div>
            <a href="{{ url_for('abastecimentos_list') }}" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-arrow-left"></i> Voltar à Lista
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold text-primary">Filtros do Relatório</h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3" id="filtros-relatorio">
                <div class="col-md-3">
                    <label for="veiculo_id" class="form-label">Veículo</label>
                    <select class="form-select" id="veiculo_id" name="veiculo_id">
                        <option value="">Todos os veículos</option>
                        {% for veiculo in veiculos %}
                        <option value="{{ veiculo.id }}"
                                {{ 'selected' if request.args.get('veiculo_id') == veiculo.id|string }}>
                            {{ veiculo.placa }} - {{ veiculo.marca }} {{ veiculo.modelo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="motorista_id" class="form-label">Motorista</label>
                    <select class="form-select" id="motorista_id" name="motorista_id">
                        <option value="">Todos os motoristas</option>
                        {% for motorista in motoristas %}
                        <option value="{{ motorista.id }}"
                                {{ 'selected' if request.args.get('motorista_id') == motorista.id|string }}>
                            {{ motorista.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="data_inicio" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                           value="{{ data_inicio or '' }}">
                </div>
                <div class="col-md-2">
                    <label for="data_fim" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim"
                           value="{{ data_fim or '' }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-funnel"></i> Atualizar
                    </button>
                    <a href="{{ url_for('reports_abastecimentos') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Limpar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Estatísticas Gerais -->
    <div class="row mb-4">
        <div class="col-xl col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Total Abastecimentos
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ estatisticas.total_abastecimentos }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-fuel-pump fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Total Litros
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {{ "{:,.2f}".format(estatisticas.total_litros) }}L
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-droplet fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                Valor Total
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                R$ {{ "{:,.2f}".format(estatisticas.total_valor) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-currency-dollar fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Preço Médio/L
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                R$ {{ "{:.2f}".format(estatisticas.media_preco_litro) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-danger text-uppercase mb-1">
                                Consumo Médio
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {{ "{:.2f}".format(estatisticas.consumo_medio_geral) if estatisticas.consumo_medio_geral > 0 else 'N/A' }} km/L
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-speedometer2 fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos e Tabelas -->
    <div class="row">
        <!-- Relatório por Veículo -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Relatório por Veículo</h6>
                </div>
                <div class="card-body">
                    {% if estatisticas.por_veiculo %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" style="font-size: 0.70rem;">
                            <thead>
                                <tr>
                                    <th>Veículo</th>
                                    <th>Abastec.</th>
                                    <th>Litros</th>
                                    <th>Consumo</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in estatisticas.por_veiculo %}
                                <tr>
                                    <td>
                                        <strong>{{ item.veiculo.placa or 'N/A' }}</strong><br>
                                        <small class="text-muted">{{ item.veiculo.marca }} {{ item.veiculo.modelo }}</small>
                                    </td>
                                    <td>{{ item.total_abastecimentos }}</td>
                                    <td>{{ "{:.1f}".format(item.total_litros) }}L</td>
                                    <td>
                                        {% if item.consumo_medio > 0 %}
                                            <span class="badge bg-{% if item.consumo_medio >= 3 %}success{% elif item.consumo_medio >= 2 %}warning{% else %}danger{% endif %}">
                                                {{ "{:.2f}".format(item.consumo_medio) }} km/L
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>R$ {{ "{:.2f}".format(item.total_valor) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-fuel-pump display-3 text-muted"></i>
                        <p class="text-muted mt-2">Nenhum dado disponível</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Relatório por Mês -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Relatório por Mês</h6>
                </div>
                <div class="card-body">
                    {% if estatisticas.por_mes %}
                    <!-- Gráfico de Linhas -->
                    <div class="mb-4">
                        <canvas id="chartMensal" width="400" height="200"></canvas>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" style="font-size: 0.70rem;">
                            <thead>
                                <tr>
                                    <th>Mês</th>
                                    <th>Abastec.</th>
                                    <th>Litros</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in estatisticas.por_mes %}
                                <tr>
                                    <td>{{ item.mes }}</td>
                                    <td>{{ item.total_abastecimentos }}</td>
                                    <td>{{ "{:.1f}".format(item.total_litros) }}L</td>
                                    <td>R$ {{ "{:.2f}".format(item.total_valor) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-calendar display-3 text-muted"></i>
                        <p class="text-muted mt-2">Nenhum dado disponível</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Consumo por Veículo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Consumo Médio por Veículo</h6>
                </div>
                <div class="card-body">
                    {% if estatisticas.por_veiculo %}
                    <canvas id="chartConsumo" width="400" height="100"></canvas>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-speedometer2 display-3 text-muted"></i>
                        <p class="text-muted mt-2">Nenhum dado de consumo disponível</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Lista Detalhada de Abastecimentos -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold text-primary">Lista Detalhada de Abastecimentos</h6>
        </div>
        <div class="card-body">
            {% if abastecimentos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="abastecimentosTable" style="font-size: 0.70rem;">
                    <thead class="table-dark">
                        <tr>
                            <th>Data</th>
                            <th>Veículo</th>
                            <th>Motorista</th>
                            <th>Posto</th>
                            <th>Odômetro</th>
                            <th>Litros</th>
                            <th>R$/L</th>
                            <th>Total</th>
                            <th>Combustível</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for abastecimento in abastecimentos %}
                        <tr>
                            <td>
                                {{ abastecimento.data_abastecimento|datetime if abastecimento.data_abastecimento else '-' }}
                            </td>
                            <td>
                                {% if abastecimento.veiculo and abastecimento.veiculo.placa %}
                                    <span class="fw-bold">{{ abastecimento.veiculo.placa }}</span><br>
                                    <small class="text-muted">{{ abastecimento.veiculo.marca or '' }} {{ abastecimento.veiculo.modelo or '' }}</small>
                                {% elif abastecimento.veiculo_id %}
                                    <span class="text-muted">Veículo ID: {{ abastecimento.veiculo_id }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if abastecimento.motorista and abastecimento.motorista.nome %}
                                    {{ abastecimento.motorista.nome }}
                                {% elif abastecimento.motorista_id %}
                                    <span class="text-muted">Motorista ID: {{ abastecimento.motorista_id }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ abastecimento.posto or '-' }}</td>
                            <td>{{ "{:,}".format(abastecimento.odometro).replace(',', '.') if abastecimento.odometro else '-' }} km</td>
                            <td>{{ abastecimento.litros }}L</td>
                            <td>R$ {{ abastecimento.valor_litro }}</td>
                            <td class="fw-bold">R$ {{ abastecimento.valor_total }}</td>
                            <td>{{ abastecimento.tipo_combustivel or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-fuel-pump display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">Nenhum abastecimento encontrado</h4>
                <p class="text-muted">
                    {% if request.args %}
                        Nenhum abastecimento corresponde aos filtros aplicados.
                        <a href="{{ url_for('reports_abastecimentos') }}" class="btn btn-link">Limpar filtros</a>
                    {% else %}
                        Não há abastecimentos registrados para este período.
                    {% endif %}
                </p>
                <a href="{{ url_for('abastecimento_new') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Registrar Abastecimento
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Inicializar DataTable
    $('#abastecimentosTable').DataTable({
        "pageLength": 25,
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json"
        },
        "order": [[0, "desc"]], // Ordenar por data decrescente
        "columnDefs": [
            { "orderable": false, "targets": -1 } // Última coluna não ordenável
        ]
    });

    // Gráfico de linha mensal
    {% if estatisticas.por_mes %}
    const dadosMensais = {{ estatisticas.por_mes | tojson }};

    const ctx = document.getElementById('chartMensal').getContext('2d');
    const chartMensal = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dadosMensais.map(item => item.mes),
            datasets: [{
                label: 'Valor Total (R$)',
                data: dadosMensais.map(item => item.total_valor),
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.1,
                yAxisID: 'y'
            }, {
                label: 'Litros',
                data: dadosMensais.map(item => item.total_litros),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Mês'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Valor Total (R$)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Litros'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Evolução Mensal de Abastecimentos'
                }
            }
        }
    });
    {% endif %}

    // Gráfico de barras - Consumo por Veículo
    {% if estatisticas.por_veiculo %}
    const dadosConsumo = {{ estatisticas.por_veiculo | tojson }};
    const veiculosComConsumo = dadosConsumo.filter(item => item.consumo_medio > 0);

    if (veiculosComConsumo.length > 0) {
        const ctxConsumo = document.getElementById('chartConsumo').getContext('2d');
        const chartConsumo = new Chart(ctxConsumo, {
            type: 'bar',
            data: {
                labels: veiculosComConsumo.map(item => item.veiculo.placa || 'N/A'),
                datasets: [{
                    label: 'Consumo Médio (km/L)',
                    data: veiculosComConsumo.map(item => item.consumo_medio),
                    backgroundColor: veiculosComConsumo.map(item => {
                        if (item.consumo_medio >= 3) return 'rgba(40, 167, 69, 0.7)';  // Verde
                        if (item.consumo_medio >= 2) return 'rgba(255, 193, 7, 0.7)';  // Amarelo
                        return 'rgba(220, 53, 69, 0.7)';  // Vermelho
                    }),
                    borderColor: veiculosComConsumo.map(item => {
                        if (item.consumo_medio >= 3) return 'rgb(40, 167, 69)';
                        if (item.consumo_medio >= 2) return 'rgb(255, 193, 7)';
                        return 'rgb(220, 53, 69)';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Consumo (km/L)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Veículo'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Consumo Médio por Veículo'
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = veiculosComConsumo[context.dataIndex];
                                return [
                                    `Consumo: ${context.parsed.y.toFixed(2)} km/L`,
                                    `Abastecimentos: ${item.total_abastecimentos}`,
                                    `Total Litros: ${item.total_litros.toFixed(1)}L`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}