{% extends "base.html" %}

{% block title %}
    {% if usuario.id %}Editar Usu√°rio{% else %}Novo Usu√°rio{% endif %} - SSO Transpontual
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 mb-0 text-gray-800">
            {% if usuario.id %}Editar Usu√°rio{% else %}Novo Usu√°rio{% endif %}
            <span class="badge bg-info ms-2">SSO Integrado</span>
        </h1>
        <div>
            <a href="{{ url_for('users_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar √† Lista
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="bi bi-person-gear"></i> Dados do Usu√°rio
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" id="usuario-form">
                        <!-- Dados B√°sicos -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" id="nome" name="nome"
                                       value="{{ usuario.nome or request.form.get('nome') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email"
                                       value="{{ usuario.email or request.form.get('email') }}"
                                       autocomplete="username" required>
                                <div class="form-text">
                                    <i class="bi bi-shield-check text-success"></i>
                                    Este email ser√° usado para SSO entre sistemas
                                </div>
                            </div>
                        </div>

                        <!-- Perfil Unificado SSO -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="papel" class="form-label">
                                    Perfil Principal *
                                    <i class="bi bi-question-circle" data-bs-toggle="tooltip"
                                       title="Define permiss√µes base em todos os sistemas"></i>
                                </label>
                                <select class="form-select" id="papel" name="papel" required>
                                    <option value="">Selecione um perfil</option>
                                    <option value="admin"
                                        {{ 'selected' if (usuario.papel or request.form.get('papel')) == 'admin' }}>
                                        üîß Administrador Global
                                    </option>
                                    <option value="gestor"
                                        {{ 'selected' if (usuario.papel or request.form.get('papel')) == 'gestor' }}>
                                        üëî Gestor de Opera√ß√µes
                                    </option>
                                    <option value="fiscal"
                                        {{ 'selected' if (usuario.papel or request.form.get('papel')) == 'fiscal' }}>
                                        üìã Respons√°vel Fiscal
                                    </option>
                                    <option value="financeiro"
                                        {{ 'selected' if (usuario.papel or request.form.get('papel')) == 'financeiro' }}>
                                        üí∞ Analista Financeiro
                                    </option>
                                    <option value="operacional"
                                        {{ 'selected' if (usuario.papel or request.form.get('papel')) == 'operacional' }}>
                                        üöõ Operador de Frota
                                    </option>
                                    <option value="estagiario"
                                        {{ 'selected' if (usuario.papel or request.form.get('papel')) == 'estagiario' }}>
                                        üéì Estagi√°rio
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="ativo" class="form-label">Status da Conta</label>
                                <select class="form-select" id="ativo" name="ativo">
                                    <option value="1"
                                        {% if (usuario.get('ativo', True) and usuario.id) or (not usuario.id) or request.form.get('ativo') == '1' %}selected{% endif %}>
                                        ‚úÖ Ativo (Acesso a todos os sistemas)
                                    </option>
                                    <option value="0"
                                        {% if usuario.get('ativo') == False or request.form.get('ativo') == '0' %}selected{% endif %}>
                                        ‚ùå Inativo (Sem acesso)
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Permiss√µes por Sistema -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-shield-lock"></i> Permiss√µes por Sistema
                                </label>
                                <div class="border rounded p-3 bg-light">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6 class="text-primary">üöõ Sistema de Frotas</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_frotas_admin" name="permissoes_frotas" value="admin">
                                                <label class="form-check-label" for="perm_frotas_admin">
                                                    Administrador
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_frotas_gestor" name="permissoes_frotas" value="gestor">
                                                <label class="form-check-label" for="perm_frotas_gestor">
                                                    Gestor de Frota
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_frotas_operador" name="permissoes_frotas" value="operador">
                                                <label class="form-check-label" for="perm_frotas_operador">
                                                    Operador
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-success">üìä Dashboard Baker</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_baker_admin" name="permissoes_baker" value="admin">
                                                <label class="form-check-label" for="perm_baker_admin">
                                                    Administrador
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_baker_financeiro" name="permissoes_baker" value="financeiro">
                                                <label class="form-check-label" for="perm_baker_financeiro">
                                                    M√≥dulo Financeiro
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_baker_operador" name="permissoes_baker" value="operador">
                                                <label class="form-check-label" for="perm_baker_operador">
                                                    Operador
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-warning">üí∞ Sistema Financeiro</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_fin_admin" name="permissoes_financeiro" value="admin">
                                                <label class="form-check-label" for="perm_fin_admin">
                                                    Administrador
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_fin_gestor" name="permissoes_financeiro" value="gestor">
                                                <label class="form-check-label" for="perm_fin_gestor">
                                                    Gestor Financeiro
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="perm_fin_operador" name="permissoes_financeiro" value="operador">
                                                <label class="form-check-label" for="perm_fin_operador">
                                                    Analista
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Permiss√µes s√£o aplicadas automaticamente via SSO
                                </div>
                            </div>
                        </div>

                        {% if not usuario.id %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="senha" class="form-label">Senha *</label>
                                <input type="password" class="form-control" id="senha" name="senha"
                                       autocomplete="new-password" required>
                                <div class="form-text">M√≠nimo 6 caracteres. Usada em todos os sistemas</div>
                            </div>
                            <div class="col-md-6">
                                <label for="confirmar_senha" class="form-label">Confirmar Senha *</label>
                                <input type="password" class="form-control" id="confirmar_senha"
                                       name="confirmar_senha" autocomplete="new-password" required>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Controles de Acesso SSO -->
                        <hr>
                        <h6 class="fw-bold text-secondary mb-3">
                            <i class="bi bi-shield-check"></i> Controles de Acesso SSO
                        </h6>

                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="horario_inicio" class="form-label">Hor√°rio In√≠cio</label>
                                <input type="time" class="form-control" id="horario_inicio" name="horario_inicio"
                                       value="{{ usuario.horario_inicio|datetime('%H:%M') if usuario.horario_inicio else (request.form.get('horario_inicio') or '') }}">
                                <div class="form-text">Aplica-se a todos os sistemas</div>
                            </div>
                            <div class="col-md-3">
                                <label for="horario_fim" class="form-label">Hor√°rio Fim</label>
                                <input type="time" class="form-control" id="horario_fim" name="horario_fim"
                                       value="{{ usuario.horario_fim|datetime('%H:%M') if usuario.horario_fim else (request.form.get('horario_fim') or '') }}">
                                <div class="form-text">Aplica-se a todos os sistemas</div>
                            </div>
                            <div class="col-md-3">
                                <label for="data_validade" class="form-label">Data Validade</label>
                                <input type="date" class="form-control" id="data_validade" name="data_validade"
                                       value="{{ usuario.data_validade|datetime('%Y-%m-%d') if usuario.data_validade else (request.form.get('data_validade') or '') }}">
                                <div class="form-text">Expira acesso SSO</div>
                            </div>
                            <div class="col-md-3">
                                <label for="max_sessoes" class="form-label">M√°x Sess√µes</label>
                                <input type="number" class="form-control" id="max_sessoes" name="max_sessoes"
                                       min="1" max="10" value="{{ usuario.max_sessoes or request.form.get('max_sessoes', 3) }}">
                                <div class="form-text">Sess√µes simult√¢neas</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="dias_semana" class="form-label">Dias da Semana Permitidos</label>
                                <div class="form-check-group">
                                    {% set dias_selecionados = (usuario.dias_semana or request.form.get('dias_semana', '')).split(',') %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="seg" name="dias_semana" value="1"
                                               {{ 'checked' if '1' in dias_selecionados }}>
                                        <label class="form-check-label" for="seg">Seg</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="ter" name="dias_semana" value="2"
                                               {{ 'checked' if '2' in dias_selecionados }}>
                                        <label class="form-check-label" for="ter">Ter</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="qua" name="dias_semana" value="3"
                                               {{ 'checked' if '3' in dias_selecionados }}>
                                        <label class="form-check-label" for="qua">Qua</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="qui" name="dias_semana" value="4"
                                               {{ 'checked' if '4' in dias_selecionados }}>
                                        <label class="form-check-label" for="qui">Qui</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="sex" name="dias_semana" value="5"
                                               {{ 'checked' if '5' in dias_selecionados }}>
                                        <label class="form-check-label" for="sex">Sex</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="sab" name="dias_semana" value="6"
                                               {{ 'checked' if '6' in dias_selecionados }}>
                                        <label class="form-check-label" for="sab">S√°b</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="dom" name="dias_semana" value="7"
                                               {{ 'checked' if '7' in dias_selecionados }}>
                                        <label class="form-check-label" for="dom">Dom</label>
                                    </div>
                                </div>
                                <div class="form-text">Restri√ß√£o aplicada em todos os sistemas</div>
                            </div>
                            <div class="col-md-6">
                                <label for="ips_permitidos" class="form-label">IPs Permitidos</label>
                                <textarea class="form-control" id="ips_permitidos" name="ips_permitidos" rows="3"
                                          placeholder="192.168.1.100, 10.0.0.50">{{ usuario.ips_permitidos or request.form.get('ips_permitidos') }}</textarea>
                                <div class="form-text">V√°lido para SSO entre sistemas</div>
                            </div>
                        </div>

                        <!-- Teste SSO -->
                        {% if usuario.id %}
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-link-45deg"></i> Teste de Navega√ß√£o SSO</h6>
                                    <p class="mb-2">Gerar links de teste para este usu√°rio:</p>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="gerarLinkSSO('frotas')">
                                        üöõ Testar Frotas
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="gerarLinkSSO('baker')">
                                        üìä Testar Baker
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="gerarLinkSSO('financeiro')">
                                        üí∞ Testar Financeiro
                                    </button>
                                    <div id="link-sso-result" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="localizacao_restrita" name="localizacao_restrita" value="1"
                                           {% if usuario.get('localizacao_restrita') or request.form.get('localizacao_restrita') %}checked{% endif %}>
                                    <label class="form-check-label" for="localizacao_restrita">
                                        Restringir por localiza√ß√£o (requer valida√ß√£o adicional)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i>
                                    {% if usuario.id %}Atualizar Usu√°rio{% else %}Criar Usu√°rio{% endif %}
                                </button>
                                <a href="{{ url_for('users_list') }}" class="btn btn-secondary ms-2">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                                {% if usuario.id %}
                                <a href="{{ url_for('user_permissions', user_id=usuario.id) }}" class="btn btn-info ms-2">
                                    <i class="bi bi-shield-check"></i> Gerenciar Permiss√µes
                                </a>
                                <button type="button" class="btn btn-warning ms-2" onclick="sincronizarUsuarioSSO()">
                                    <i class="bi bi-arrow-repeat"></i> Sincronizar SSO
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Card de SSO Status -->
            <div class="card shadow mb-4 border-success">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 fw-bold">
                        <i class="bi bi-shield-check"></i> Status SSO
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <strong>SSO Ativo</strong>
                    </div>
                    <p class="small text-muted mb-3">
                        Este usu√°rio pode navegar entre todos os sistemas sem re-login.
                    </p>

                    <div id="sistemas-disponiveis">
                        <h6 class="fw-bold text-dark">Sistemas Dispon√≠veis:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-1">
                                <i class="bi bi-truck text-primary"></i>
                                <strong>Sistema de Frotas</strong>
                                <span class="badge bg-success ms-2">Ativo</span>
                            </li>
                            <li class="mb-1">
                                <i class="bi bi-bar-chart text-success"></i>
                                <strong>Dashboard Baker</strong>
                                <span class="badge bg-success ms-2">Ativo</span>
                            </li>
                            <li class="mb-1">
                                <i class="bi bi-currency-dollar text-warning"></i>
                                <strong>Sistema Financeiro</strong>
                                <span class="badge bg-success ms-2">Ativo</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Card de Guia SSO -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-info">
                        <i class="bi bi-question-circle"></i> Guia SSO
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-person-gear display-4 text-info"></i>
                    </div>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            <strong>Perfil Principal:</strong> Define acesso base em todos os sistemas
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-shield-check text-primary"></i>
                            <strong>Permiss√µes por Sistema:</strong> Controle granular de acesso
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-clock text-warning"></i>
                            <strong>Restri√ß√µes:</strong> Aplicadas automaticamente via SSO
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-link-45deg text-info"></i>
                            <strong>Navega√ß√£o:</strong> Login √∫nico para todos os sistemas
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Perfil Selecionado -->
            <div class="card shadow mb-4" id="perfil-info">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Mapeamento de Permiss√µes</h6>
                </div>
                <div class="card-body">
                    <div id="perfil-details">
                        <p class="text-muted">Selecione um perfil para ver o mapeamento SSO</p>
                    </div>
                </div>
            </div>

            {% if usuario.id %}
            <!-- Informa√ß√µes de Acesso SSO -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-secondary">Informa√ß√µes de Acesso SSO</h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p><strong>Criado em:</strong> {{ usuario.criado_em|datetime }}</p>
                        {% if usuario.ultimo_acesso %}
                        <p><strong>√öltimo acesso:</strong> {{ usuario.ultimo_acesso|datetime }}</p>
                        <p><strong>√öltimo IP:</strong> {{ usuario.ultimo_ip or 'N/A' }}</p>
                        <p><strong>Sistema de origem:</strong>
                            <span class="badge bg-primary">Frotas</span>
                        </p>
                        {% endif %}
                        <p><strong>Tentativas de login:</strong> {{ usuario.tentativas_login or 0 }}</p>
                        <p><strong>Sess√µes ativas:</strong>
                            <span class="badge bg-success">1</span> / {{ usuario.max_sessoes or 3 }}
                        </p>
                        {% if usuario.bloqueado_ate %}
                        <p class="text-danger"><strong>Bloqueado at√©:</strong> {{ usuario.bloqueado_ate|datetime }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Mostrar permiss√µes do perfil selecionado com mapeamento SSO
    function mostrarPermissoesPerfil() {
        const papel = document.getElementById('papel').value;
        const detailsDiv = document.getElementById('perfil-details');

        const perfisSSO = {
            'admin': {
                'descricao': 'Acesso administrativo completo',
                'sistemas': {
                    'frotas': ['frotas:admin'],
                    'baker': ['baker:admin'],
                    'financeiro': ['financeiro:admin']
                },
                'modulos': ['Todos os m√≥dulos de todos os sistemas']
            },
            'gestor': {
                'descricao': 'Gest√£o operacional e relat√≥rios',
                'sistemas': {
                    'frotas': ['frotas:gestor'],
                    'baker': ['baker:operador'],
                    'financeiro': ['financeiro:viewer']
                },
                'modulos': ['Ve√≠culos', 'Motoristas', 'Checklists', 'Dashboard Baker', 'Relat√≥rios Financeiros']
            },
            'fiscal': {
                'descricao': 'Documentos fiscais e compliance',
                'sistemas': {
                    'frotas': ['frotas:viewer'],
                    'baker': ['baker:financeiro'],
                    'financeiro': ['financeiro:operador']
                },
                'modulos': ['Documentos Fiscais', 'M√≥dulo Financeiro Baker', 'Relat√≥rios Fiscais']
            },
            'financeiro': {
                'descricao': 'An√°lise e controles financeiros',
                'sistemas': {
                    'frotas': ['frotas:viewer'],
                    'baker': ['baker:financeiro'],
                    'financeiro': ['financeiro:gestor']
                },
                'modulos': ['Dashboard Financeiro', 'Contas', 'Receitas', 'Despesas', 'Relat√≥rios']
            },
            'operacional': {
                'descricao': 'Opera√ß√µes b√°sicas de frota',
                'sistemas': {
                    'frotas': ['frotas:operador'],
                    'baker': ['baker:viewer'],
                    'financeiro': ['financeiro:viewer']
                },
                'modulos': ['Checklists', 'Ve√≠culos (visualizar)', 'Dashboard B√°sico']
            },
            'estagiario': {
                'descricao': 'Acesso limitado com supervis√£o',
                'sistemas': {
                    'frotas': ['frotas:viewer'],
                    'baker': ['baker:viewer'],
                    'financeiro': ['financeiro:viewer']
                },
                'modulos': ['Visualiza√ß√£o apenas', 'Relat√≥rios b√°sicos']
            }
        };

        if (papel && perfisSSO[papel]) {
            const perfil = perfisSSO[papel];
            detailsDiv.innerHTML = `
                <div class="text-center mb-3">
                    <i class="bi bi-diagram-3 display-4 text-primary"></i>
                </div>
                <p><strong>Descri√ß√£o:</strong><br>${perfil.descricao}</p>
                <p><strong>Mapeamento SSO:</strong></p>
                <ul class="small">
                    <li>üöõ Frotas: <code>${perfil.sistemas.frotas.join(', ')}</code></li>
                    <li>üìä Baker: <code>${perfil.sistemas.baker.join(', ')}</code></li>
                    <li>üí∞ Financeiro: <code>${perfil.sistemas.financeiro.join(', ')}</code></li>
                </ul>
                <p><strong>M√≥dulos acess√≠veis:</strong></p>
                <ul class="small">
                    ${perfil.modulos.map(m => `<li>${m}</li>`).join('')}
                </ul>
            `;

            // Auto-selecionar permiss√µes baseadas no perfil
            autoSelecionarPermissoes(perfil.sistemas);
        } else {
            detailsDiv.innerHTML = '<p class="text-muted">Selecione um perfil para ver o mapeamento SSO</p>';
        }
    }

    // Auto-selecionar permiss√µes baseadas no perfil
    function autoSelecionarPermissoes(sistemas) {
        // Limpar sele√ß√µes
        document.querySelectorAll('input[name^="permissoes_"]').forEach(cb => cb.checked = false);

        // Selecionar baseado no mapeamento
        if (sistemas.frotas.includes('frotas:admin')) {
            document.getElementById('perm_frotas_admin').checked = true;
        } else if (sistemas.frotas.includes('frotas:gestor')) {
            document.getElementById('perm_frotas_gestor').checked = true;
        } else if (sistemas.frotas.includes('frotas:operador')) {
            document.getElementById('perm_frotas_operador').checked = true;
        }

        if (sistemas.baker.includes('baker:admin')) {
            document.getElementById('perm_baker_admin').checked = true;
        } else if (sistemas.baker.includes('baker:financeiro')) {
            document.getElementById('perm_baker_financeiro').checked = true;
        } else if (sistemas.baker.includes('baker:operador')) {
            document.getElementById('perm_baker_operador').checked = true;
        }

        if (sistemas.financeiro.includes('financeiro:admin')) {
            document.getElementById('perm_fin_admin').checked = true;
        } else if (sistemas.financeiro.includes('financeiro:gestor')) {
            document.getElementById('perm_fin_gestor').checked = true;
        } else if (sistemas.financeiro.includes('financeiro:operador')) {
            document.getElementById('perm_fin_operador').checked = true;
        }
    }

    // Event listeners
    document.getElementById('papel').addEventListener('change', mostrarPermissoesPerfil);
    mostrarPermissoesPerfil(); // Inicializar

    // Valida√ß√£o de senhas
    {% if not usuario.id %}
    function validarSenhas() {
        const senha = document.getElementById('senha').value;
        const confirmar = document.getElementById('confirmar_senha').value;

        if (senha !== confirmar) {
            document.getElementById('confirmar_senha').setCustomValidity('As senhas n√£o coincidem');
        } else {
            document.getElementById('confirmar_senha').setCustomValidity('');
        }
    }

    document.getElementById('senha').addEventListener('input', validarSenhas);
    document.getElementById('confirmar_senha').addEventListener('input', validarSenhas);
    {% endif %}

    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Fun√ß√£o para gerar link de teste SSO
function gerarLinkSSO(sistema) {
    const resultDiv = document.getElementById('link-sso-result');
    const urls = {
        'frotas': 'https://transpontual-sistema-frotas.onrender.com/auth/sso-login',
        'baker': 'https://dashboard.transpontual.app.br/auth/sso-login',
        'financeiro': 'https://financeiro.transpontual.app.br/auth/sso-login'
    };

    resultDiv.innerHTML = `
        <div class="alert alert-info mt-2">
            <strong>üîó Link de teste SSO para ${sistema}:</strong><br>
            <code>${urls[sistema]}?jwt_token=TOKEN_AQUI</code><br>
            <small class="text-muted">Este link seria gerado dinamicamente com o token do usu√°rio</small>
        </div>
    `;
}

// Fun√ß√£o para sincronizar usu√°rio entre sistemas
function sincronizarUsuarioSSO() {
    if (confirm('Deseja sincronizar este usu√°rio com todos os sistemas SSO?')) {
        // Aqui faria a sincroniza√ß√£o real
        alert('‚úÖ Usu√°rio sincronizado com sucesso em todos os sistemas!');
    }
}
</script>
{% endblock %}