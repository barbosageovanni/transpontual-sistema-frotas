{% extends "base.html" %}

{% block title %}Ordem de Serviço {{ ordem.numero_os }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 mb-0 text-gray-800">Ordem de Serviço {{ ordem.numero_os }}</h1>
        <div>
            {% if ordem.status != 'Concluída' %}
            <a href="{{ url_for('service_order_edit', ordem_id=ordem.id) }}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Editar
            </a>
            {% endif %}
            <a href="{{ url_for('service_orders_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar à Lista
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Informações Principais -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-primary">Informações da Ordem de Serviço</h6>
                    {% set status_class = {
                        'Aberta': 'primary',
                        'Em Andamento': 'warning',
                        'Concluída': 'success',
                        'Cancelada': 'secondary'
                    } %}
                    <span class="badge bg-{{ status_class.get(ordem.status, 'secondary') }} fs-6">
                        {{ ordem.status }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold" width="40%">Número OS:</td>
                                    <td class="fs-5 fw-bold text-primary">{{ ordem.numero_os }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Tipo de Serviço:</td>
                                    <td>
                                        <span class="badge bg-info">{{ ordem.tipo_servico }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Veículo:</td>
                                    <td>
                                        {% if ordem.veiculo %}
                                            <span class="fw-bold">{{ ordem.veiculo.placa }}</span><br>
                                            <small class="text-muted">{{ ordem.veiculo.marca }} {{ ordem.veiculo.modelo }}</small>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Oficina:</td>
                                    <td>{{ ordem.oficina or '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Odômetro:</td>
                                    <td>{{ "{:,}".format(ordem.odometro).replace(',', '.') if ordem.odometro else '-' }} km</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold" width="40%">Data Abertura:</td>
                                    <td>{{ ordem.data_abertura.strftime('%d/%m/%Y às %H:%M') if ordem.data_abertura else '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Data Prevista:</td>
                                    <td>
                                        {% if ordem.data_prevista %}
                                            {{ ordem.data_prevista.strftime('%d/%m/%Y') }}
                                            {% set days_diff = (ordem.data_prevista - (ordem.data_conclusao or current_datetime)).days %}
                                            {% if days_diff < 0 and ordem.status != 'Concluída' %}
                                                <br><span class="badge bg-danger">Atrasada</span>
                                            {% elif days_diff <= 3 and ordem.status not in ['Concluída', 'Cancelada'] %}
                                                <br><span class="badge bg-warning">Urgente</span>
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Data Conclusão:</td>
                                    <td>{{ ordem.data_conclusao.strftime('%d/%m/%Y às %H:%M') if ordem.data_conclusao else '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Valor Total:</td>
                                    <td>
                                        {% if ordem.valor_total %}
                                            <span class="fs-4 text-success fw-bold">R$ {{ "%.2f"|format(ordem.valor_total) }}</span>
                                        {% else %}
                                            <span class="text-muted">Não informado</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Descrições -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Descrições</h6>
                </div>
                <div class="card-body">
                    {% if ordem.descricao_problema %}
                    <div class="mb-4">
                        <h6 class="fw-bold text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Problema Identificado:
                        </h6>
                        <div class="bg-light p-3 rounded border-start border-danger border-3">
                            {{ ordem.descricao_problema }}
                        </div>
                    </div>
                    {% endif %}

                    {% if ordem.descricao_servico %}
                    <div class="mb-4">
                        <h6 class="fw-bold text-info">
                            <i class="bi bi-tools"></i> Serviços Realizados/Planejados:
                        </h6>
                        <div class="bg-light p-3 rounded border-start border-info border-3">
                            {{ ordem.descricao_servico }}
                        </div>
                    </div>
                    {% endif %}

                    {% if ordem.observacoes %}
                    <div class="mb-3">
                        <h6 class="fw-bold text-secondary">
                            <i class="bi bi-chat-left-text"></i> Observações:
                        </h6>
                        <div class="bg-light p-3 rounded border-start border-secondary border-3">
                            {{ ordem.observacoes }}
                        </div>
                    </div>
                    {% endif %}

                    {% if not ordem.descricao_problema and not ordem.descricao_servico and not ordem.observacoes %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-file-text display-4"></i>
                        <p class="mt-2">Nenhuma descrição adicional fornecida</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Itens da Ordem de Serviço -->
            {% if ordem.itens %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Itens da Ordem de Serviço</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Descrição</th>
                                    <th>Quantidade</th>
                                    <th>Valor Unit.</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ordem.itens %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if item.tipo_item == 'peca' else 'info' }}">
                                            {{ 'Peça' if item.tipo_item == 'peca' else 'Serviço' }}
                                        </span>
                                    </td>
                                    <td>{{ item.descricao }}</td>
                                    <td>{{ item.quantidade }}</td>
                                    <td>R$ {{ item.valor_unitario or '0,00' }}</td>
                                    <td class="fw-bold">R$ {{ "%.2f"|format(item.valor_total) if item.valor_total else '0,00' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-dark">
                                <tr>
                                    <td colspan="4" class="fw-bold text-end">TOTAL GERAL:</td>
                                    <td class="fw-bold fs-5">R$ {{ "%.2f"|format(ordem.valor_total) if ordem.valor_total else '0,00' }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Informações de Auditoria -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-secondary">Informações de Registro</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Criada em:</strong> {{ ordem.criado_em.strftime('%d/%m/%Y às %H:%M') if ordem.criado_em else '-' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>ID do Registro:</strong> #{{ ordem.id }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Status e Progresso -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-{{ status_class.get(ordem.status, 'secondary') }}">Status da Ordem</h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        {% if ordem.status == 'Aberta' %}
                            <i class="bi bi-clipboard-plus display-4 text-primary"></i>
                        {% elif ordem.status == 'Em Andamento' %}
                            <i class="bi bi-tools display-4 text-warning"></i>
                        {% elif ordem.status == 'Concluída' %}
                            <i class="bi bi-check-circle display-4 text-success"></i>
                        {% else %}
                            <i class="bi bi-x-circle display-4 text-secondary"></i>
                        {% endif %}
                    </div>
                    <h4 class="text-{{ status_class.get(ordem.status, 'secondary') }}">{{ ordem.status }}</h4>

                    {% if ordem.status == 'Aberta' %}
                        <p class="text-muted">Aguardando início dos trabalhos</p>
                    {% elif ordem.status == 'Em Andamento' %}
                        <p class="text-muted">Trabalhos em execução</p>
                    {% elif ordem.status == 'Concluída' %}
                        <p class="text-muted">Serviço finalizado</p>
                    {% else %}
                        <p class="text-muted">Ordem cancelada</p>
                    {% endif %}

                    <!-- Barra de Progresso -->
                    <div class="progress mb-3">
                        {% if ordem.status == 'Aberta' %}
                            <div class="progress-bar bg-primary" style="width: 25%"></div>
                        {% elif ordem.status == 'Em Andamento' %}
                            <div class="progress-bar bg-warning" style="width: 75%"></div>
                        {% elif ordem.status == 'Concluída' %}
                            <div class="progress-bar bg-success" style="width: 100%"></div>
                        {% else %}
                            <div class="progress-bar bg-secondary" style="width: 0%"></div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Ações -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-dark">Ações</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if ordem.status != 'Concluída' %}
                        <a href="{{ url_for('service_order_edit', ordem_id=ordem.id) }}"
                           class="btn btn-warning">
                            <i class="bi bi-pencil"></i> Editar Ordem
                        </a>
                        {% endif %}

                        <button type="button" class="btn btn-outline-primary" onclick="imprimirOS()">
                            <i class="bi bi-printer"></i> Imprimir OS
                        </button>

                        {% if ordem.status == 'Aberta' %}
                        <button type="button" class="btn btn-outline-warning" onclick="alterarStatus('Em Andamento')">
                            <i class="bi bi-play-circle"></i> Iniciar Trabalhos
                        </button>
                        {% elif ordem.status == 'Em Andamento' %}
                        <button type="button" class="btn btn-outline-success" onclick="alterarStatus('Concluída')">
                            <i class="bi bi-check-circle"></i> Concluir OS
                        </button>
                        {% endif %}

                        <button type="button" class="btn btn-outline-danger" onclick="confirmarExclusao()">
                            <i class="bi bi-trash"></i> Excluir OS
                        </button>
                    </div>
                </div>
            </div>

            <!-- Informações do Veículo -->
            {% if ordem.veiculo %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Informações do Veículo</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-truck display-4 text-primary"></i>
                    </div>
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="fw-bold">Placa:</td>
                            <td>{{ ordem.veiculo.placa }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Marca/Modelo:</td>
                            <td>{{ ordem.veiculo.marca }} {{ ordem.veiculo.modelo }}</td>
                        </tr>
                        {% if ordem.veiculo.ano %}
                        <tr>
                            <td class="fw-bold">Ano:</td>
                            <td>{{ ordem.veiculo.ano }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="fw-bold">KM Atual:</td>
                            <td>{{ "{:,}".format(ordem.veiculo.km_atual).replace(',', '.') if ordem.veiculo.km_atual else '-' }} km</td>
                        </tr>
                    </table>
                    <div class="d-grid">
                        <a href="{{ url_for('vehicles_list') }}"
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> Ver Detalhes do Veículo
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                </div>
                <p class="text-center">Tem certeza que deseja excluir esta ordem de serviço?</p>
                <div class="alert alert-warning">
                    <strong>Atenção:</strong> Esta ação não pode ser desfeita e removerá permanentemente:
                    <ul class="mb-0 mt-2">
                        <li>Dados da ordem de serviço</li>
                        <li>Itens e valores</li>
                        <li>Histórico de manutenção</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('service_order_delete', ordem_id=ordem.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Confirmar Exclusão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmarExclusao() {
    const modal = new bootstrap.Modal(document.getElementById('modalExclusao'));
    modal.show();
}

function alterarStatus(novoStatus) {
    if (confirm(`Tem certeza que deseja alterar o status para "${novoStatus}"?`)) {
        // Implementar chamada AJAX para alterar status
        fetch('/ordens-servico/{{ ordem.id }}/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: novoStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao alterar status: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro ao alterar status');
        });
    }
}

function imprimirOS() {
    // Criar uma nova janela para impressão
    const printWindow = window.open('', '_blank');

    const content = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Ordem de Serviço {{ ordem.numero_os }}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                .section { margin-bottom: 20px; }
                .label { font-weight: bold; }
                .value { margin-left: 10px; }
                .status { font-size: 18px; font-weight: bold; }
                .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                .table th { background-color: #f2f2f2; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>ORDEM DE SERVIÇO</h2>
                <h3>{{ ordem.numero_os }}</h3>
                <p>Transpontual - Sistema de Gestão de Frotas</p>
            </div>

            <div class="section">
                <div><span class="label">Status:</span><span class="value status">{{ ordem.status }}</span></div>
                <div><span class="label">Tipo:</span><span class="value">{{ ordem.tipo_servico }}</span></div>
                <div><span class="label">Data Abertura:</span><span class="value">{{ ordem.data_abertura.strftime('%d/%m/%Y às %H:%M') if ordem.data_abertura else '-' }}</span></div>
                {% if ordem.data_prevista %}
                <div><span class="label">Data Prevista:</span><span class="value">{{ ordem.data_prevista.strftime('%d/%m/%Y') }}</span></div>
                {% endif %}
            </div>

            <div class="section">
                <div><span class="label">Veículo:</span><span class="value">{{ ordem.veiculo.placa if ordem.veiculo else '-' }} - {{ ordem.veiculo.marca if ordem.veiculo else '' }} {{ ordem.veiculo.modelo if ordem.veiculo else '' }}</span></div>
                <div><span class="label">Oficina:</span><span class="value">{{ ordem.oficina or '-' }}</span></div>
                <div><span class="label">Odômetro:</span><span class="value">{{ "{:,}".format(ordem.odometro).replace(',', '.') if ordem.odometro else '-' }} km</span></div>
            </div>

            {% if ordem.descricao_problema %}
            <div class="section">
                <div><span class="label">Problema:</span></div>
                <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">{{ ordem.descricao_problema }}</div>
            </div>
            {% endif %}

            {% if ordem.descricao_servico %}
            <div class="section">
                <div><span class="label">Serviços:</span></div>
                <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">{{ ordem.descricao_servico }}</div>
            </div>
            {% endif %}

            {% if ordem.valor_total %}
            <div class="section">
                <div><span class="label">Valor Total:</span><span class="value status">R$ {{ "%.2f"|format(ordem.valor_total) }}</span></div>
            </div>
            {% endif %}

            <div class="section" style="margin-top: 50px; text-align: center; font-size: 12px; color: #666;">
                <p>Documento gerado em {{ current_datetime.strftime('%d/%m/%Y às %H:%M') }}</p>
            </div>
        </body>
        </html>
    `;

    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
</script>
{% endblock %}